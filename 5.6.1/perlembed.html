      
      
      
      

      <!DOCTYPE html>
      <html lang="en">

      <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="description" content="perlembed - perldoc.perl.org">
        <link rel="icon" href="/public/img/favicon.ico">
        <title>perlembed - perldoc.perl.org</title>
        <link href="/public/css/main.min.css" rel="stylesheet">
        <link rel="canonical" href="/perlembed.html">
        <link
          href='https://fonts.googleapis.com/css?family=Lato:400,100,300,700,900'
          rel='stylesheet' type='text/css'>
        <script>
          window.ga = window.ga || function () {
            (ga.q = ga.q || []).push(arguments)
          };
          ga.l = +new Date;
          ga('create', 'UA-1892152-2', 'auto'); // JJ's account
          ga('create', 'UA-50555-3', 'auto', 'perlOrg'); // perl.org account
          ga('require', 'outboundLinkTracker', {
            events: ['click', 'auxclick', 'contextmenu'],
          });
          ga('require', 'maxScrollTracker');
          ga('send', 'pageview');
          ga('perlOrg.send', 'pageview');
        </script>
        <script async src="https://www.google-analytics.com/analytics.js">
        </script>
        <script async src="/public/js/tracking.min.js"></script>
      </head>

      <body class="body container-fluid ">
        <div class="wrapper">

          <nav
    class="navbar navbar-dark bg-primary bg-perl fixed-top justify-content-between navbar-expand-lg">
    <a href="#content" class="skippy sr-only sr-only-focusable">
        <span class=' skippy-text'>Skip to main content</span>
    </a>
    <a class="navbar-brand" href="/">
        <img class="logo" src="/public/img/logo_perl_doc.svg"
            alt="Perl Documentation Logo" />
    </a>
    <button class="navbar-toggler" type="button" data-toggle="collapse"
        data-target="#navbar" aria-controls="navbar" aria-expanded="false"
        aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
    </button>
    <div id="navbar" class="collapse navbar-collapse ">
        <ul class="navbar-nav ml-auto navbar-right">
            <form class="nav-item dropdown search-wrapper">
                <input type="text" id='searchinput' aria-describedby='navbarDropdown5'
                    placeholder="Type query" class='search-input-field' value=''>

                <button href="#" data-toggle='dropdown' type="button"
                    aria-haspopup="true" aria-expanded='false' id="navbarDropdown5"
                    class="nav-link dropdown-toggle search-link">
                    <object tabindex='-1' focusable="false" class='search-icon'
                        data="/public/img/search.svg" type="image/svg+xml"
                        name='search icon'>search
                        icon</object>
                </button>
                <div class="dropdown-menu" aria-labelledby="navbarDropdown5"
                    id='search-results'>
                    <p class='dropdown-item major-version'>
                        No results
                    </p>
                </div>
            </form>
            <li class="nav-item dropdown">
                <a id="navbarDropdown" href="#" class="nav-link dropdown-toggle"
                    data-toggle="dropdown" role="button" aria-haspopup="true"
                    aria-expanded="false">Perl versions</a>
                <div class="dropdown-menu" aria-labelledby="navbarDropdown">
                    
                        <p class='dropdown-item major-version'>
                            5.32
                        </p>
                        
                        <a class='dropdown-item minor-version' href="/5.32.0/">5.32.0</a>
                        
                        
                        <div class="dropdown-divider"></div>
                        
                    
                        <p class='dropdown-item major-version'>
                            5.30
                        </p>
                        
                        <a class='dropdown-item minor-version' href="/5.30.3/">5.30.3</a>
                        
                        <a class='dropdown-item minor-version' href="/5.30.2/">5.30.2</a>
                        
                        <a class='dropdown-item minor-version' href="/5.30.1/">5.30.1</a>
                        
                        <a class='dropdown-item minor-version' href="/5.30.0/">5.30.0</a>
                        
                        
                        <div class="dropdown-divider"></div>
                        
                    
                        <p class='dropdown-item major-version'>
                            5.28
                        </p>
                        
                        <a class='dropdown-item minor-version' href="/5.28.3/">5.28.3</a>
                        
                        <a class='dropdown-item minor-version' href="/5.28.2/">5.28.2</a>
                        
                        <a class='dropdown-item minor-version' href="/5.28.1/">5.28.1</a>
                        
                        <a class='dropdown-item minor-version' href="/5.28.0/">5.28.0</a>
                        
                        
                        <div class="dropdown-divider"></div>
                        
                    
                        <p class='dropdown-item major-version'>
                            5.26
                        </p>
                        
                        <a class='dropdown-item minor-version' href="/5.26.3/">5.26.3</a>
                        
                        <a class='dropdown-item minor-version' href="/5.26.2/">5.26.2</a>
                        
                        <a class='dropdown-item minor-version' href="/5.26.1/">5.26.1</a>
                        
                        <a class='dropdown-item minor-version' href="/5.26.0/">5.26.0</a>
                        
                        
                        <div class="dropdown-divider"></div>
                        
                    
                        <p class='dropdown-item major-version'>
                            5.24
                        </p>
                        
                        <a class='dropdown-item minor-version' href="/5.24.4/">5.24.4</a>
                        
                        <a class='dropdown-item minor-version' href="/5.24.3/">5.24.3</a>
                        
                        <a class='dropdown-item minor-version' href="/5.24.2/">5.24.2</a>
                        
                        <a class='dropdown-item minor-version' href="/5.24.1/">5.24.1</a>
                        
                        <a class='dropdown-item minor-version' href="/5.24.0/">5.24.0</a>
                        
                        
                        <div class="dropdown-divider"></div>
                        
                    
                        <p class='dropdown-item major-version'>
                            5.22
                        </p>
                        
                        <a class='dropdown-item minor-version' href="/5.22.4/">5.22.4</a>
                        
                        <a class='dropdown-item minor-version' href="/5.22.3/">5.22.3</a>
                        
                        <a class='dropdown-item minor-version' href="/5.22.2/">5.22.2</a>
                        
                        <a class='dropdown-item minor-version' href="/5.22.1/">5.22.1</a>
                        
                        <a class='dropdown-item minor-version' href="/5.22.0/">5.22.0</a>
                        
                        
                        <div class="dropdown-divider"></div>
                        
                    
                        <p class='dropdown-item major-version'>
                            5.20
                        </p>
                        
                        <a class='dropdown-item minor-version' href="/5.20.3/">5.20.3</a>
                        
                        <a class='dropdown-item minor-version' href="/5.20.2/">5.20.2</a>
                        
                        <a class='dropdown-item minor-version' href="/5.20.1/">5.20.1</a>
                        
                        <a class='dropdown-item minor-version' href="/5.20.0/">5.20.0</a>
                        
                        
                        <div class="dropdown-divider"></div>
                        
                    
                        <p class='dropdown-item major-version'>
                            5.18
                        </p>
                        
                        <a class='dropdown-item minor-version' href="/5.18.4/">5.18.4</a>
                        
                        <a class='dropdown-item minor-version' href="/5.18.3/">5.18.3</a>
                        
                        <a class='dropdown-item minor-version' href="/5.18.2/">5.18.2</a>
                        
                        <a class='dropdown-item minor-version' href="/5.18.1/">5.18.1</a>
                        
                        <a class='dropdown-item minor-version' href="/5.18.0/">5.18.0</a>
                        
                        
                        <div class="dropdown-divider"></div>
                        
                    
                        <p class='dropdown-item major-version'>
                            5.16
                        </p>
                        
                        <a class='dropdown-item minor-version' href="/5.16.3/">5.16.3</a>
                        
                        <a class='dropdown-item minor-version' href="/5.16.2/">5.16.2</a>
                        
                        <a class='dropdown-item minor-version' href="/5.16.1/">5.16.1</a>
                        
                        <a class='dropdown-item minor-version' href="/5.16.0/">5.16.0</a>
                        
                        
                        <div class="dropdown-divider"></div>
                        
                    
                        <p class='dropdown-item major-version'>
                            5.14
                        </p>
                        
                        <a class='dropdown-item minor-version' href="/5.14.4/">5.14.4</a>
                        
                        <a class='dropdown-item minor-version' href="/5.14.3/">5.14.3</a>
                        
                        <a class='dropdown-item minor-version' href="/5.14.2/">5.14.2</a>
                        
                        <a class='dropdown-item minor-version' href="/5.14.1/">5.14.1</a>
                        
                        <a class='dropdown-item minor-version' href="/5.14.0/">5.14.0</a>
                        
                        
                        <div class="dropdown-divider"></div>
                        
                    
                        <p class='dropdown-item major-version'>
                            5.12
                        </p>
                        
                        <a class='dropdown-item minor-version' href="/5.12.5/">5.12.5</a>
                        
                        <a class='dropdown-item minor-version' href="/5.12.4/">5.12.4</a>
                        
                        <a class='dropdown-item minor-version' href="/5.12.3/">5.12.3</a>
                        
                        <a class='dropdown-item minor-version' href="/5.12.2/">5.12.2</a>
                        
                        <a class='dropdown-item minor-version' href="/5.12.1/">5.12.1</a>
                        
                        <a class='dropdown-item minor-version' href="/5.12.0/">5.12.0</a>
                        
                        
                        <div class="dropdown-divider"></div>
                        
                    
                        <p class='dropdown-item major-version'>
                            5.10
                        </p>
                        
                        <a class='dropdown-item minor-version' href="/5.10.1/">5.10.1</a>
                        
                        <a class='dropdown-item minor-version' href="/5.10.0/">5.10.0</a>
                        
                        
                        <div class="dropdown-divider"></div>
                        
                    
                        <p class='dropdown-item major-version'>
                            5.8
                        </p>
                        
                        <a class='dropdown-item minor-version' href="/5.8.9/">5.8.9</a>
                        
                        <a class='dropdown-item minor-version' href="/5.8.8/">5.8.8</a>
                        
                        <a class='dropdown-item minor-version' href="/5.8.7/">5.8.7</a>
                        
                        <a class='dropdown-item minor-version' href="/5.8.6/">5.8.6</a>
                        
                        <a class='dropdown-item minor-version' href="/5.8.5/">5.8.5</a>
                        
                        <a class='dropdown-item minor-version' href="/5.8.4/">5.8.4</a>
                        
                        <a class='dropdown-item minor-version' href="/5.8.3/">5.8.3</a>
                        
                        <a class='dropdown-item minor-version' href="/5.8.2/">5.8.2</a>
                        
                        <a class='dropdown-item minor-version' href="/5.8.1/">5.8.1</a>
                        
                        <a class='dropdown-item minor-version' href="/5.8.0/">5.8.0</a>
                        
                        
                        <div class="dropdown-divider"></div>
                        
                    
                        <p class='dropdown-item major-version'>
                            5.6
                        </p>
                        
                        <a class='dropdown-item minor-version' href="/5.6.2/">5.6.2</a>
                        
                        <a class='dropdown-item minor-version' href="/5.6.1/">5.6.1</a>
                        
                        <a class='dropdown-item minor-version' href="/5.6.0/">5.6.0</a>
                        
                        
                    
                </div>
            </li>
            <li class="nav-item dropdown">
                <a id="navbarDropdown1" href="#" class="dropdown-toggle nav-link"
                    data-toggle="dropdown" role="button" aria-haspopup="true"
                    aria-expanded="false">Manuals</a>
                <div class="dropdown-menu" aria-labelledby="navbarDropdown1">
                    <a class="dropdown-item"
                        href="/5.6.1/index-overview.html">Overview</a>
                    <a class="dropdown-item"
                        href="/5.6.1/index-tutorials.html">Tutorials</a>
                    <a class="dropdown-item"
                        href="/5.6.1/index-faq.html">FAQs</a>
                    <a class="dropdown-item"
                        href="/5.6.1/index-history.html">Changes</a>
                    <a class="dropdown-item"
                        href="/5.6.1/index-licence.html">License</a>
                    <a class="dropdown-item"
                        href="/5.6.1/index-language.html">Language</a>
                    <a class="dropdown-item"
                        href="/5.6.1/index-functions.html">Functions</a>
                    <a class="dropdown-item"
                        href="/5.6.1/perlop.html">Operators</a>
                    <a class="dropdown-item"
                        href="/5.6.1/perlvar.html">Variables</a>
                    <a class="dropdown-item"
                        href="/5.6.1/index-pragmas.html">Pragmas</a>
                    <a class="dropdown-item"
                        href="/5.6.1/index-utilities.html">Utilities</a>
                    <a class="dropdown-item"
                        href="/5.6.1/index-internals.html">Internals</a>
                    <a class="dropdown-item"
                        href="/5.6.1/index-platforms.html">Platforms</a>
                </div>
            </li>
            <li class="nav-item dropdown">
                <a id="navbarDropdown3" href="#" class="nav-link dropdown-toggle "
                    data-toggle="dropdown" role="button" aria-haspopup="true"
                    aria-expanded="false">Modules</a>
                <div aria-labelledby="navbarDropdown3"
                    class="dropdown-menu letters-wrap">
                    <!--<a class="dropdown-item"
                        href="/5.6.1/index-modules.html">A-Z</a>
                    <a class="dropdown-item"
                        href="/5.6.1/index-modules-by-cat.html">By
                        Category</a>-->
                    <div class="dropdown-divider"></div>
                    <div class="letter-container">
                        <a class="dropdown-item letters"
                            href="/5.6.1/index-modules-A.html">A</a>
                        <a class="dropdown-item letters"
                            href="/5.6.1/index-modules-B.html">B</a>
                        <a class="dropdown-item letters"
                            href="/5.6.1/index-modules-C.html">C</a>
                        <a class="dropdown-item letters"
                            href="/5.6.1/index-modules-D.html">D</a>
                        <a class="dropdown-item letters"
                            href="/5.6.1/index-modules-E.html">E</a>
                        <a class="dropdown-item letters"
                            href="/5.6.1/index-modules-F.html">F</a>
                        <a class="dropdown-item letters"
                            href="/5.6.1/index-modules-G.html">G</a>
                        <a class="dropdown-item letters"
                            href="/5.6.1/index-modules-H.html">H</a>
                        <a class="dropdown-item letters"
                            href="/5.6.1/index-modules-I.html">I</a>
                        <a class="dropdown-item letters"
                            href="/5.6.1/index-modules-J.html">J</a>
                        <a class="dropdown-item letters"
                            href="/5.6.1/index-modules-K.html">K</a>
                        <a class="dropdown-item letters"
                            href="/5.6.1/index-modules-L.html">L</a>
                        <a class="dropdown-item letters"
                            href="/5.6.1/index-modules-M.html">M</a>
                        <a class="dropdown-item letters"
                            href="/5.6.1/index-modules-N.html">N</a>
                        <a class="dropdown-item letters"
                            href="/5.6.1/index-modules-O.html">O</a>
                        <a class="dropdown-item letters"
                            href="/5.6.1/index-modules-P.html">P</a>
                        <a class="dropdown-item letters"
                            href="/5.6.1/index-modules-Q.html">Q</a>
                        <a class="dropdown-item letters"
                            href="/5.6.1/index-modules-R.html">R</a>
                        <a class="dropdown-item letters"
                            href="/5.6.1/index-modules-S.html">S</a>
                        <a class="dropdown-item letters"
                            href="/5.6.1/index-modules-T.html">T</a>
                        <a class="dropdown-item letters"
                            href="/5.6.1/index-modules-U.html">U</a>
                        <a class="dropdown-item letters"
                            href="/5.6.1/index-modules-V.html">V</a>
                        <a class="dropdown-item letters"
                            href="/5.6.1/index-modules-W.html">W</a>
                        <a class="dropdown-item letters"
                            href="/5.6.1/index-modules-X.html">X</a>
                        <a class="dropdown-item letters"
                            href="/5.6.1/index-modules-Y.html">Y</a>
                        <a class="dropdown-item letters"
                            href="/5.6.1/index-modules-Z.html">Z</a>
                    </div>
                </div>
            </li>
            <li class="nav-item dropdown">
                <a id="navbarDropdown4" href="#" class="nav-link dropdown-toggle "
                    data-toggle="dropdown" role="button" aria-haspopup="true"
                    aria-expanded="false">Functions</a>
                <div aria-labelledby="navbarDropdown4"
                    class="dropdown-menu letters-wrap">
                    <a class="dropdown-item"
                        href="/5.6.1/index-functions.html">A-Z</a>
                    <a class="dropdown-item"
                        href="/5.6.1/index-functions-by-cat.html">By
                        Category</a>
                    <div class="dropdown-divider"></div>
                    <div class="letter-container">
                        <a class="dropdown-item letters"
                            href="/5.6.1/index-functions.html#A">A</a>
                        <a class="dropdown-item letters"
                            href="/5.6.1/index-functions.html#B">B</a>
                        <a class="dropdown-item letters"
                            href="/5.6.1/index-functions.html#C">C</a>
                        <a class="dropdown-item letters"
                            href="/5.6.1/index-functions.html#D">D</a>
                        <a class="dropdown-item letters"
                            href="/5.6.1/index-functions.html#E">E</a>
                        <a class="dropdown-item letters"
                            href="/5.6.1/index-functions.html#F">F</a>
                        <a class="dropdown-item letters"
                            href="/5.6.1/index-functions.html#G">G</a>
                        <a class="dropdown-item letters"
                            href="/5.6.1/index-functions.html#H">H</a>
                        <a class="dropdown-item letters"
                            href="/5.6.1/index-functions.html#I">I</a>
                        <a class="dropdown-item letters"
                            href="/5.6.1/index-functions.html#J">J</a>
                        <a class="dropdown-item letters"
                            href="/5.6.1/index-functions.html#K">K</a>
                        <a class="dropdown-item letters"
                            href="/5.6.1/index-functions.html#L">L</a>
                        <a class="dropdown-item letters"
                            href="/5.6.1/index-functions.html#M">M</a>
                        <a class="dropdown-item letters"
                            href="/5.6.1/index-functions.html#N">N</a>
                        <a class="dropdown-item letters"
                            href="/5.6.1/index-functions.html#O">O</a>
                        <a class="dropdown-item letters"
                            href="/5.6.1/index-functions.html#P">P</a>
                        <a class="dropdown-item letters"
                            href="/5.6.1/index-functions.html#Q">Q</a>
                        <a class="dropdown-item letters"
                            href="/5.6.1/index-functions.html#R">R</a>
                        <a class="dropdown-item letters"
                            href="/5.6.1/index-functions.html#S">S</a>
                        <a class="dropdown-item letters"
                            href="/5.6.1/index-functions.html#T">T</a>
                        <a class="dropdown-item letters"
                            href="/5.6.1/index-functions.html#U">U</a>
                        <a class="dropdown-item letters"
                            href="/5.6.1/index-functions.html#V">V</a>
                        <a class="dropdown-item letters"
                            href="/5.6.1/index-functions.html#W">W</a>
                        <a class="dropdown-item letters"
                            href="/5.6.1/index-functions.html#X">X</a>
                        <a class="dropdown-item letters"
                            href="/5.6.1/index-functions.html#Y">Y</a>
                        <a class="dropdown-item letters"
                            href="/5.6.1/index-functions.html#Z">Z</a>
                    </div>
                </div>
            </li>
        </ul>
    </div>
    <!--/.nav-collapse -->
</nav>


          <main class="row main-content pb-5 pt-5" id='content'>
            <div class="col-sm-10 offset-sm-1 col-xl-8 offset-xl-2">
              <div class="row">
                <div class="col-sm-12">
                  <div id="breadcrumbs">
                      
    <a href="index.html">Home</a>&nbsp; &gt;
    
      
        <a href="index-internals.html">Internals and C language interface</a> &gt;
      
    
    perlembed
  

                  </div>
                </div>
              </div>
              <div class="row">
                <article class="col-sm-12 content">
                  <div class="documentation-wrapper">
                    <div id="perl_version">
                      <h7 class='page-title'> Perl 5 version 6.1
                        documentation</h7>
                    </div>
                    <h1>perlembed</h1>


  <!--    -->
<ul><li><a href="#NAME">NAME</a></li><li><a href="#DESCRIPTION">DESCRIPTION</a></li><ul><li><a href="#PREAMBLE">PREAMBLE</a></li><li><a href="#ROADMAP">ROADMAP</a></li><li><a href="#Compiling-your-C-program">Compiling your C program</a></li><li><a href="#Adding-a-Perl-interpreter-to-your-C-program">Adding a Perl interpreter to your C program</a></li><li><a href="#Calling-a-Perl-subroutine-from-your-C-program">Calling a Perl subroutine from your C program</a></li><li><a href="#Evaluating-a-Perl-statement-from-your-C-program">Evaluating a Perl statement from your C program</a></li><li><a href="#Performing-Perl-pattern-matches-and-substitutions-from-your-C-program">Performing Perl pattern matches and substitutions from your C program</a></li><li><a href="#Fiddling-with-the-Perl-stack-from-your-C-program">Fiddling with the Perl stack from your C program</a></li><li><a href="#Maintaining-a-persistent-interpreter">Maintaining a persistent interpreter</a></li><li><a href="#Maintaining-multiple-interpreter-instances">Maintaining multiple interpreter instances</a></li><li><a href="#Using-Perl-modules%2c-which-themselves-use-C-libraries%2c-from-your-C-program">Using Perl modules, which themselves use C libraries, from your C program</a></li></ul><li><a href="#Embedding-Perl-under-Win32">Embedding Perl under Win32</a></li><li><a href="#MORAL">MORAL</a></li><li><a href="#AUTHOR">AUTHOR</a></li><li><a href="#COPYRIGHT">COPYRIGHT</a></li></ul><a class='view-head1' id="NAME"></a><h2 class='h2' >NAME</h2>
<p>perlembed - how to embed perl in your C program</p>
<a class='view-head1' id="DESCRIPTION"></a><h2 class='h2' >DESCRIPTION</h2>
<a class='view-head2' id="PREAMBLE"></a><h3 class='h3' >PREAMBLE</h3>
<p>Do you want to:</p>
<ul>
<li><a class='view-title' id="*Use-C-from-Perl%3f*"></a><strong><strong>Use C from Perl?</strong></strong>
<p>Read <a href="perlxstut.html">perlxstut</a>, <a href="perlxs.html">perlxs</a>, <a href="h2xs.html">h2xs</a>, <a href="perlguts.html">perlguts</a>, and <a href="perlapi.html">perlapi</a>.</p>
</li>
<li><a class='view-title' id="*Use-a-Unix-program-from-Perl%3f*"></a><strong><strong>Use a Unix program from Perl?</strong></strong>
<p>Read about back-quotes and about <code class="inline"><a class="l_k" href="functions/system.html">system</a></code> and <code class="inline"><a class="l_k" href="functions/exec.html">exec</a></code> in <a href="perlfunc.html">perlfunc</a>.</p>
</li>
<li><a class='view-title' id="*Use-Perl-from-Perl%3f*"></a><strong><strong>Use Perl from Perl?</strong></strong>
<p>Read about <a class='function-name' href="functions/do.html">do</a> and <a class='function-name' href="functions/eval.html">eval</a> and <a class='function-name' href="functions/require.html">require</a> 
and <a class='function-name' href="functions/use.html">use</a>.</p>
</li>
<li><a class='view-title' id="*Use-C-from-C%3f*"></a><strong><strong>Use C from C?</strong></strong>
<p>Rethink your design.</p>
</li>
<li><a class='view-title' id="*Use-Perl-from-C%3f*"></a><strong><strong>Use Perl from C?</strong></strong>
<p>Read on...</p>
</li>
</ul>
<a class='view-head2' id="ROADMAP"></a><h3 class='h3' >ROADMAP</h3>
<ul>
<li>
<p>Compiling your C program</p>
</li>
<li>
<p>Adding a Perl interpreter to your C program</p>
</li>
<li>
<p>Calling a Perl subroutine from your C program</p>
</li>
<li>
<p>Evaluating a Perl statement from your C program</p>
</li>
<li>
<p>Performing Perl pattern matches and substitutions from your C program</p>
</li>
<li>
<p>Fiddling with the Perl stack from your C program</p>
</li>
<li>
<p>Maintaining a persistent interpreter</p>
</li>
<li>
<p>Maintaining multiple interpreter instances</p>
</li>
<li>
<p>Using Perl modules, which themselves use C libraries, from your C program</p>
</li>
<li>
<p>Embedding Perl under Win32</p>
</li>
</ul>
<a class='view-head2' id="Compiling-your-C-program"></a><h3 class='h3' >Compiling your C program</h3>
<p>If you have trouble compiling the scripts in this documentation,
you're not alone.  The cardinal rule: COMPILE THE PROGRAMS IN EXACTLY
THE SAME WAY THAT YOUR PERL WAS COMPILED.  (Sorry for yelling.)</p>
<p>Also, every C program that uses Perl must link in the <i>perl library</i>.
What's that, you ask?  Perl is itself written in C; the perl library
is the collection of compiled C programs that were used to create your
perl executable (<i>/usr/bin/perl</i> or equivalent).  (Corollary: you
can't use Perl from your C program unless Perl has been compiled on
your machine, or installed properly--that's why you shouldn't blithely
copy Perl executables from machine to machine without also copying the
<i>lib</i> directory.)</p>
<p>When you use Perl from C, your C program will--usually--allocate,
"run", and deallocate a <i>PerlInterpreter</i> object, which is defined by
the perl library.</p>
<p>If your copy of Perl is recent enough to contain this documentation
(version 5.002 or later), then the perl library (and <i>EXTERN.h</i> and
<i>perl.h</i>, which you'll also need) will reside in a directory
that looks like this:</p>
<pre class="verbatim"><ol><li>    <span class="q">/usr/</span><a class="l_k" href="functions/local.html">local</a><span class="q">/lib/perl5</span>/<span class="w">your_architecture_here</span>/<span class="w">CORE</span></li></ol></pre><p>or perhaps just</p>
<pre class="verbatim"><ol><li>    <span class="q">/usr/</span><a class="l_k" href="functions/local.html">local</a><span class="q">/lib/perl5</span>/<span class="w">CORE</span></li></ol></pre><p>or maybe something like</p>
<pre class="verbatim"><ol><li>    <span class="q">/usr/opt</span>/<span class="w">perl5</span>/<span class="w">CORE</span></li></ol></pre><p>Execute this statement for a hint about where to find CORE:</p>
<pre class="verbatim"><ol><li>    <span class="w">perl</span> -<span class="w">MConfig</span> -e <span class="q">&#39;print $Config{archlib}&#39;</span></li></ol></pre><p>Here's how you'd compile the example in the next section,
<a href="#Adding-a-Perl-interpreter-to-your-C-program">Adding a Perl interpreter to your C program</a>, on my Linux box:</p>
<pre class="verbatim"><ol><li>    <span class="i">% gcc</span> -<span class="w">O2</span> -<span class="w">Dbool</span>=<span class="w">char</span> -<span class="w">DHAS_BOOL</span> -<span class="w">I</span>/<span class="w">usr</span>/<a class="l_k" href="functions/local.html">local</a><span class="q">/include</span></li><li>    <span class="q">    -I/</span><span class="w">usr</span>/<a class="l_k" href="functions/local.html">local</a><span class="q">/lib/perl5</span>/<span class="w">i586</span>-<span class="w">linux</span>/<span class="n">5.003</span>/<span class="w">CORE</span></li><li>    -<span class="w">L</span>/<span class="w">usr</span>/<a class="l_k" href="functions/local.html">local</a><span class="q">/lib/perl5</span>/<span class="w">i586</span>-<span class="w">linux</span>/<span class="n">5.003</span>/<span class="w">CORE</span></li><li>    -o <span class="w">interp</span> <span class="w">interp</span>.<span class="w">c</span> -<span class="w">lperl</span> -<span class="w">lm</span></li></ol></pre><p>(That's all one line.)  On my DEC Alpha running old 5.003_05, the 
incantation is a bit different:</p>
<pre class="verbatim"><ol><li>    <span class="i">% cc</span> -<span class="w">O2</span> -<span class="w">Olimit</span> <span class="n">2900</span> -<span class="w">DSTANDARD_C</span> -<span class="w">I</span>/<span class="w">usr</span>/<a class="l_k" href="functions/local.html">local</a><span class="q">/include</span></li><li>    <span class="q">    -I/</span><span class="w">usr</span>/<a class="l_k" href="functions/local.html">local</a><span class="q">/lib/perl5</span>/<span class="w">alpha</span>-<span class="w">dec_osf</span>/<span class="n">5.00305</span>/<span class="w">CORE</span></li><li>    -<span class="w">L</span>/<span class="w">usr</span>/<a class="l_k" href="functions/local.html">local</a><span class="q">/lib/perl5</span>/<span class="w">alpha</span>-<span class="w">dec_osf</span>/<span class="n">5.00305</span>/<span class="w">CORE</span> -<span class="w">L</span>/<span class="w">usr</span>/<a class="l_k" href="functions/local.html">local</a><span class="q">/lib</span></li><li>    <span class="q">    -D__LANGUAGE_C__ -D_NO_PROTO -o interp interp.c -lperl -lm</span></li></ol></pre><p>How can you figure out what to add?  Assuming your Perl is post-5.001,
execute a <code class="inline"><span class="w">perl</span> -<span class="w">V</span></code>
 command and pay special attention to the "cc" and
"ccflags" information.</p>
<p>You'll have to choose the appropriate compiler (<i>cc</i>, <i>gcc</i>, et al.) for
your machine: <code class="inline"><span class="w">perl</span> -<span class="w">MConfig</span> -e <span class="q">&#39;print $Config{cc}&#39;</span></code>
 will tell you what
to use.</p>
<p>You'll also have to choose the appropriate library directory
(<i>/usr/local/lib/...</i>) for your machine.  If your compiler complains
that certain functions are undefined, or that it can't locate
<i>-lperl</i>, then you need to change the path following the <code class="inline">-<span class="w">L</span></code>
.  If it
complains that it can't find <i>EXTERN.h</i> and <i>perl.h</i>, you need to
change the path following the <code class="inline">-<span class="w">I</span></code>
.</p>
<p>You may have to add extra libraries as well.  Which ones?
Perhaps those printed by</p>
<pre class="verbatim"><ol><li>   <span class="w">perl</span> -<span class="w">MConfig</span> -e <span class="q">&#39;print $Config{libs}&#39;</span></li></ol></pre><p>Provided your perl binary was properly configured and installed the
<strong>ExtUtils::Embed</strong> module will determine all of this information for
you:</p>
<pre class="verbatim"><ol><li>   <span class="i">% cc</span> -<span class="w">o</span> <span class="w">interp</span> <span class="w">interp</span>.<span class="w">c</span> <span class="q">`perl -MExtUtils::Embed -e ccopts -e ldopts`</span></li></ol></pre><p>If the <strong>ExtUtils::Embed</strong> module isn't part of your Perl distribution,
you can retrieve it from
<a href="http://www.perl.com/perl/CPAN/modules/by-module/ExtUtils/">http://www.perl.com/perl/CPAN/modules/by-module/ExtUtils/</a>.  (If
this documentation came from your Perl distribution, then you're
running 5.004 or better and you already have it.)</p>
<p>The <strong>ExtUtils::Embed</strong> kit on CPAN also contains all source code for
the examples in this document, tests, additional examples and other
information you may find useful.</p>
<a class='view-head2' id="Adding-a-Perl-interpreter-to-your-C-program"></a><h3 class='h3' >Adding a Perl interpreter to your C program</h3>
<p>In a sense, perl (the C program) is a good example of embedding Perl
(the language), so I'll demonstrate embedding with <i>miniperlmain.c</i>,
included in the source distribution.  Here's a bastardized, nonportable
version of <i>miniperlmain.c</i> containing the essentials of embedding:</p>
<pre class="verbatim"><ol><li>    <span class="c">#include &lt;EXTERN.h&gt;               /* from the Perl distribution     */</span></li><li>    <span class="c">#include &lt;perl.h&gt;                 /* from the Perl distribution     */</span></li><li></li><li>    <span class="w">static</span> <span class="w">PerlInterpreter</span> *<span class="w">my_perl</span><span class="sc">;</span>  <span class="q">/***    The Perl interpreter    ***/</span></li><li></li><li>    <a class="l_k" href="functions/int.html">int</a> <span class="i">main</span><span class="s">(</span><a class="l_k" href="functions/int.html">int</a> <span class="w">argc</span><span class="cm">,</span> <span class="w">char</span> **<span class="w">argv</span><span class="cm">,</span> <span class="w">char</span> **<span class="w">env</span><span class="s">)</span></li><li>    <span class="s">{</span></li><li>        <span class="w">my_perl</span> = <span class="i">perl_alloc</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span></li><li>        <span class="i">perl_construct</span><span class="s">(</span><span class="w">my_perl</span><span class="s">)</span><span class="sc">;</span></li><li>        <span class="i">perl_parse</span><span class="s">(</span><span class="w">my_perl</span><span class="cm">,</span> <span class="w">NULL</span><span class="cm">,</span> <span class="w">argc</span><span class="cm">,</span> <span class="w">argv</span><span class="cm">,</span> <span class="s">(</span><span class="w">char</span> **<span class="s">)</span><span class="w">NULL</span><span class="s">)</span><span class="sc">;</span></li><li>        <span class="i">perl_run</span><span class="s">(</span><span class="w">my_perl</span><span class="s">)</span><span class="sc">;</span></li><li>        <span class="i">perl_destruct</span><span class="s">(</span><span class="w">my_perl</span><span class="s">)</span><span class="sc">;</span></li><li>        <span class="i">perl_free</span><span class="s">(</span><span class="w">my_perl</span><span class="s">)</span><span class="sc">;</span></li><li>    <span class="s">}</span></li></ol></pre><p>Notice that we don't use the <code class="inline"><span class="w">env</span></code>
 pointer.  Normally handed to
<code class="inline"><span class="w">perl_parse</span></code>
 as its final argument, <code class="inline"><span class="w">env</span></code>
 here is replaced by
<code class="inline"><span class="w">NULL</span></code>
, which means that the current environment will be used.</p>
<p>Now compile this program (I'll call it <i>interp.c</i>) into an executable:</p>
<pre class="verbatim"><ol><li>    <span class="i">% cc</span> -<span class="w">o</span> <span class="w">interp</span> <span class="w">interp</span>.<span class="w">c</span> <span class="q">`perl -MExtUtils::Embed -e ccopts -e ldopts`</span></li></ol></pre><p>After a successful compilation, you'll be able to use <i>interp</i> just
like perl itself:</p>
<pre class="verbatim"><ol><li>    <span class="i">% interp</span></li><li>    <a class="l_k" href="functions/print.html">print</a> <span class="q">&quot;Pretty Good Perl \n&quot;</span><span class="sc">;</span></li><li>    <a class="l_k" href="functions/print.html">print</a> <span class="q">&quot;10890 - 9801 is &quot;</span><span class="cm">,</span> <span class="n">10890</span> - <span class="n">9801</span><span class="sc">;</span></li><li>    <span class="q">&lt;CTRL-D&gt;</span></li><li>    <span class="w">Pretty</span> <span class="w">Good</span> <span class="w">Perl</span></li><li>    <span class="n">10890</span> - <span class="n">9801</span> <span class="w">is</span> <span class="n">1089</span></li></ol></pre><p>or</p>
<pre class="verbatim"><ol><li>    <span class="i">% interp</span> -<span class="w">e</span> <span class="q">&#39;printf(&quot;%x&quot;, 3735928559)&#39;</span></li><li>    <span class="w">deadbeef</span></li></ol></pre><p>You can also read and execute Perl statements from a file while in the
midst of your C program, by placing the filename in <i>argv[1]</i> before
calling <i>perl_run</i>.</p>
<a class='view-head2' id="Calling-a-Perl-subroutine-from-your-C-program"></a><h3 class='h3' >Calling a Perl subroutine from your C program</h3>
<p>To call individual Perl subroutines, you can use any of the <strong>call_*</strong>
functions documented in <a href="perlcall.html">perlcall</a>.
In this example we'll use <code class="inline"><span class="w">call_argv</span></code>
.</p>
<p>That's shown below, in a program I'll call <i>showtime.c</i>.</p>
<pre class="verbatim"><ol><li>    <span class="c">#include &lt;EXTERN.h&gt;</span></li><li>    <span class="c">#include &lt;perl.h&gt;</span></li><li></li><li>    <span class="w">static</span> <span class="w">PerlInterpreter</span> *<span class="w">my_perl</span><span class="sc">;</span></li><li></li><li>    <a class="l_k" href="functions/int.html">int</a> <span class="i">main</span><span class="s">(</span><a class="l_k" href="functions/int.html">int</a> <span class="w">argc</span><span class="cm">,</span> <span class="w">char</span> **<span class="w">argv</span><span class="cm">,</span> <span class="w">char</span> **<span class="w">env</span><span class="s">)</span></li><li>    <span class="s">{</span></li><li>        <span class="w">char</span> *<span class="w">args</span><span class="s">[</span><span class="s">]</span> = <span class="s">{</span> <span class="w">NULL</span> <span class="s">}</span><span class="sc">;</span></li><li>        <span class="w">my_perl</span> = <span class="i">perl_alloc</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span></li><li>        <span class="i">perl_construct</span><span class="s">(</span><span class="w">my_perl</span><span class="s">)</span><span class="sc">;</span></li><li></li><li>        <span class="i">perl_parse</span><span class="s">(</span><span class="w">my_perl</span><span class="cm">,</span> <span class="w">NULL</span><span class="cm">,</span> <span class="w">argc</span><span class="cm">,</span> <span class="w">argv</span><span class="cm">,</span> <span class="w">NULL</span><span class="s">)</span><span class="sc">;</span></li><li></li><li>        <span class="q">/*** skipping perl_run() ***/</span></li><li></li><li>        <span class="i">call_argv</span><span class="s">(</span><span class="q">&quot;showtime&quot;</span><span class="cm">,</span> <span class="w">G_DISCARD</span> | <span class="w">G_NOARGS</span><span class="cm">,</span> <span class="w">args</span><span class="s">)</span><span class="sc">;</span></li><li></li><li>        <span class="i">perl_destruct</span><span class="s">(</span><span class="w">my_perl</span><span class="s">)</span><span class="sc">;</span></li><li>        <span class="i">perl_free</span><span class="s">(</span><span class="w">my_perl</span><span class="s">)</span><span class="sc">;</span></li><li>    <span class="s">}</span></li></ol></pre><p>where <i>showtime</i> is a Perl subroutine that takes no arguments (that's the
<i>G_NOARGS</i>) and for which I'll ignore the return value (that's the
<i>G_DISCARD</i>).  Those flags, and others, are discussed in <a href="perlcall.html">perlcall</a>.</p>
<p>I'll define the <i>showtime</i> subroutine in a file called <i>showtime.pl</i>:</p>
<pre class="verbatim"><ol><li>    <a class="l_k" href="functions/print.html">print</a> <span class="q">&quot;I shan&#39;t be printed.&quot;</span><span class="sc">;</span></li><li></li><li><a name="showtime"></a>    sub <span class="m">showtime</span> <span class="s">{</span></li><li>        <a class="l_k" href="functions/print.html">print</a> <a class="l_k" href="functions/time.html">time</a><span class="sc">;</span></li><li>    <span class="s">}</span></li></ol></pre><p>Simple enough.  Now compile and run:</p>
<pre class="verbatim"><ol><li>    <span class="i">% cc</span> -<span class="w">o</span> <span class="w">showtime</span> <span class="w">showtime</span>.<span class="w">c</span> <span class="q">`perl -MExtUtils::Embed -e ccopts -e ldopts`</span></li><li></li><li>    % <span class="w">showtime</span> <span class="w">showtime</span>.<span class="w">pl</span></li><li>    <span class="n">818284590</span></li></ol></pre><p>yielding the number of seconds that elapsed between January 1, 1970
(the beginning of the Unix epoch), and the moment I began writing this
sentence.</p>
<p>In this particular case we don't have to call <i>perl_run</i>, but in
general it's considered good practice to ensure proper initialization
of library code, including execution of all object <code class="inline">DESTROY</code>
 methods
and package <code class="inline">END <span class="s">{</span><span class="s">}</span></code>
 blocks.</p>
<p>If you want to pass arguments to the Perl subroutine, you can add
strings to the <code class="inline"><span class="w">NULL</span></code>
-terminated <code class="inline"><span class="w">args</span></code>
 list passed to
<i>call_argv</i>.  For other data types, or to examine return values,
you'll need to manipulate the Perl stack.  That's demonstrated in
<a href="#Fiddling-with-the-Perl-stack-from-your-C-program">Fiddling with the Perl stack from your C program</a>.</p>
<a class='view-head2' id="Evaluating-a-Perl-statement-from-your-C-program"></a><h3 class='h3' >Evaluating a Perl statement from your C program</h3>
<p>Perl provides two API functions to evaluate pieces of Perl code.
These are <a href="perlapi.html#eval_sv">eval_sv in perlapi</a> and <a href="perlapi.html#eval_pv">eval_pv in perlapi</a>.</p>
<p>Arguably, these are the only routines you'll ever need to execute
snippets of Perl code from within your C program.  Your code can be as
long as you wish; it can contain multiple statements; it can employ
<a class='function-name' href="functions/use.html">use</a>, <a class='function-name' href="functions/require.html">require</a>, and <a class='function-name' href="functions/do.html">do</a> to
include external Perl files.</p>
<p><i>eval_pv</i> lets us evaluate individual Perl strings, and then
extract variables for coercion into C types.  The following program,
<i>string.c</i>, executes three Perl strings, extracting an <code class="inline"><a class="l_k" href="functions/int.html">int</a></code> from
the first, a <code class="inline"><span class="w">float</span></code>
 from the second, and a <code class="inline"><span class="w">char</span> *</code>
 from the third.</p>
<pre class="verbatim"><ol><li>   <span class="c">#include &lt;EXTERN.h&gt;</span></li><li>   <span class="c">#include &lt;perl.h&gt;</span></li><li></li><li>   <span class="w">static</span> <span class="w">PerlInterpreter</span> *<span class="w">my_perl</span><span class="sc">;</span></li><li></li><li>   <span class="w">main</span> <span class="s">(</span><a class="l_k" href="functions/int.html">int</a> <span class="w">argc</span><span class="cm">,</span> <span class="w">char</span> **<span class="w">argv</span><span class="cm">,</span> <span class="w">char</span> **<span class="w">env</span><span class="s">)</span></li><li>   <span class="s">{</span></li><li>       <span class="w">STRLEN</span> <span class="w">n_a</span><span class="sc">;</span></li><li>       <span class="w">char</span> *<span class="w">embedding</span><span class="s">[</span><span class="s">]</span> = <span class="s">{</span> <span class="q">&quot;&quot;</span><span class="cm">,</span> <span class="q">&quot;-e&quot;</span><span class="cm">,</span> <span class="q">&quot;0&quot;</span> <span class="s">}</span><span class="sc">;</span></li><li></li><li>       <span class="w">my_perl</span> = <span class="i">perl_alloc</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span></li><li>       <span class="i">perl_construct</span><span class="s">(</span> <span class="w">my_perl</span> <span class="s">)</span><span class="sc">;</span></li><li></li><li>       <span class="i">perl_parse</span><span class="s">(</span><span class="w">my_perl</span><span class="cm">,</span> <span class="w">NULL</span><span class="cm">,</span> <span class="n">3</span><span class="cm">,</span> <span class="w">embedding</span><span class="cm">,</span> <span class="w">NULL</span><span class="s">)</span><span class="sc">;</span></li><li>       <span class="i">perl_run</span><span class="s">(</span><span class="w">my_perl</span><span class="s">)</span><span class="sc">;</span></li><li></li><li>       <span class="q">/** Treat $a as an integer **/</span></li><li>       <span class="i">eval_pv</span><span class="s">(</span><span class="q">&quot;$a = 3; $a **= 2&quot;</span><span class="cm">,</span> <span class="w">TRUE</span><span class="s">)</span><span class="sc">;</span></li><li>       <a class="l_k" href="functions/printf.html">printf</a><span class="s">(</span><span class="q">&quot;a = %d\n&quot;</span><span class="cm">,</span> <span class="i">SvIV</span><span class="s">(</span><span class="i">get_sv</span><span class="s">(</span><span class="q">&quot;a&quot;</span><span class="cm">,</span> <span class="w">FALSE</span><span class="s">)</span><span class="s">)</span><span class="s">)</span><span class="sc">;</span></li><li></li><li>       <span class="q">/** Treat $a as a float **/</span></li><li>       <span class="i">eval_pv</span><span class="s">(</span><span class="q">&quot;$a = 3.14; $a **= 2&quot;</span><span class="cm">,</span> <span class="w">TRUE</span><span class="s">)</span><span class="sc">;</span></li><li>       <a class="l_k" href="functions/printf.html">printf</a><span class="s">(</span><span class="q">&quot;a = %f\n&quot;</span><span class="cm">,</span> <span class="i">SvNV</span><span class="s">(</span><span class="i">get_sv</span><span class="s">(</span><span class="q">&quot;a&quot;</span><span class="cm">,</span> <span class="w">FALSE</span><span class="s">)</span><span class="s">)</span><span class="s">)</span><span class="sc">;</span></li><li></li><li>       <span class="q">/** Treat $a as a string **/</span></li><li>       <span class="i">eval_pv</span><span class="s">(</span><span class="q">&quot;$a = &#39;rekcaH lreP rehtonA tsuJ&#39;; $a = reverse($a);&quot;</span><span class="cm">,</span> <span class="w">TRUE</span><span class="s">)</span><span class="sc">;</span></li><li>       <a class="l_k" href="functions/printf.html">printf</a><span class="s">(</span><span class="q">&quot;a = %s\n&quot;</span><span class="cm">,</span> <span class="i">SvPV</span><span class="s">(</span><span class="i">get_sv</span><span class="s">(</span><span class="q">&quot;a&quot;</span><span class="cm">,</span> <span class="w">FALSE</span><span class="s">)</span><span class="cm">,</span> <span class="w">n_a</span><span class="s">)</span><span class="s">)</span><span class="sc">;</span></li><li></li><li>       <span class="i">perl_destruct</span><span class="s">(</span><span class="w">my_perl</span><span class="s">)</span><span class="sc">;</span></li><li>       <span class="i">perl_free</span><span class="s">(</span><span class="w">my_perl</span><span class="s">)</span><span class="sc">;</span></li><li>   <span class="s">}</span></li></ol></pre><p>All of those strange functions with <i>sv</i> in their names help convert Perl scalars to C types.  They're described in <a href="perlguts.html">perlguts</a> and <a href="perlapi.html">perlapi</a>.</p>
<p>If you compile and run <i>string.c</i>, you'll see the results of using
<i>SvIV()</i> to create an <code class="inline"><a class="l_k" href="functions/int.html">int</a></code>, <i>SvNV()</i> to create a <code class="inline"><span class="w">float</span></code>
, and
<i>SvPV()</i> to create a string:</p>
<pre class="verbatim"><ol><li>   <span class="w">a</span> = <span class="n">9</span></li><li>   <span class="w">a</span> = <span class="n">9.859600</span></li><li>   <span class="w">a</span> = <span class="w">Just</span> <span class="w">Another</span> <span class="w">Perl</span> <span class="w">Hacker</span></li></ol></pre><p>In the example above, we've created a global variable to temporarily
store the computed value of our eval'd expression.  It is also
possible and in most cases a better strategy to fetch the return value
from <i>eval_pv()</i> instead.  Example:</p>
<pre class="verbatim"><ol><li>   ...</li><li>   <span class="w">STRLEN</span> <span class="w">n_a</span><span class="sc">;</span></li><li>   <span class="w">SV</span> *<span class="w">val</span> = <span class="i">eval_pv</span><span class="s">(</span><span class="q">&quot;reverse &#39;rekcaH lreP rehtonA tsuJ&#39;&quot;</span><span class="cm">,</span> <span class="w">TRUE</span><span class="s">)</span><span class="sc">;</span></li><li>   <a class="l_k" href="functions/printf.html">printf</a><span class="s">(</span><span class="q">&quot;%s\n&quot;</span><span class="cm">,</span> <span class="i">SvPV</span><span class="s">(</span><span class="w">val</span><span class="cm">,</span><span class="w">n_a</span><span class="s">)</span><span class="s">)</span><span class="sc">;</span></li><li>   ...</li></ol></pre><p>This way, we avoid namespace pollution by not creating global
variables and we've simplified our code as well.</p>
<a class='view-head2' id="Performing-Perl-pattern-matches-and-substitutions-from-your-C-program"></a><h3 class='h3' >Performing Perl pattern matches and substitutions from your C program</h3>
<p>The <i>eval_sv()</i> function lets us evaluate strings of Perl code, so we can
define some functions that use it to "specialize" in matches and
substitutions: <i>match()</i>, <i>substitute()</i>, and <i>matches()</i>.</p>
<pre class="verbatim"><ol><li>   <span class="w">I32</span> <span class="i">match</span><span class="s">(</span><span class="w">SV</span> *<span class="w">string</span><span class="cm">,</span> <span class="w">char</span> *<span class="w">pattern</span><span class="s">)</span><span class="sc">;</span></li></ol></pre><p>Given a string and a pattern (e.g., <code class="inline"><a class="l_k" href="functions/m.html">m/clasp/</a></code> or <code class="inline"><span class="q">/\b\w*\b/</span></code>
, which
in your C program might appear as "/\\b\\w*\\b/"), match()
returns 1 if the string matches the pattern and 0 otherwise.</p>
<pre class="verbatim"><ol><li>   <a class="l_k" href="functions/int.html">int</a> <span class="i">substitute</span><span class="s">(</span><span class="w">SV</span> **<span class="w">string</span><span class="cm">,</span> <span class="w">char</span> *<span class="w">pattern</span><span class="s">)</span><span class="sc">;</span></li></ol></pre><p>Given a pointer to an <code class="inline"><span class="w">SV</span></code>
 and an <code class="inline">=~</code>
 operation (e.g.,
<code class="inline"><a class="l_k" href="functions/s.html">s/bob/robert/g</a></code> or <code class="inline"><a class="l_k" href="functions/tr.html">tr[A-Z][a-z]</a></code>), substitute() modifies the string
within the <code class="inline"><span class="w">AV</span></code>
 at according to the operation, returning the number of substitutions
made.</p>
<pre class="verbatim"><ol><li>   <a class="l_k" href="functions/int.html">int</a> <span class="i">matches</span><span class="s">(</span><span class="w">SV</span> *<span class="w">string</span><span class="cm">,</span> <span class="w">char</span> *<span class="w">pattern</span><span class="cm">,</span> <span class="w">AV</span> **<span class="w">matches</span><span class="s">)</span><span class="sc">;</span></li></ol></pre><p>Given an <code class="inline"><span class="w">SV</span></code>
, a pattern, and a pointer to an empty <code class="inline"><span class="w">AV</span></code>
,
matches() evaluates <code class="inline"><span class="i">$string</span> =~ <span class="i">$pattern</span></code>
 in a list context, and
fills in <i>matches</i> with the array elements, returning the number of matches found.</p>
<p>Here's a sample program, <i>match.c</i>, that uses all three (long lines have
been wrapped here):</p>
<pre class="verbatim"><ol><li> <span class="c">#include &lt;EXTERN.h&gt;</span></li><li> <span class="c">#include &lt;perl.h&gt;</span></li><li></li><li> <span class="q">/** my_eval_sv(code, error_check)</span></li><li> <span class="q"> ** kinda like eval_sv(), </span></li><li> <span class="q"> ** but we pop the return value off the stack </span></li><li> <span class="q"> **/</span></li><li> <span class="w">SV</span>* <span class="i">my_eval_sv</span><span class="s">(</span><span class="w">SV</span> *<span class="w">sv</span><span class="cm">,</span> <span class="w">I32</span> <span class="w">croak_on_error</span><span class="s">)</span></li><li> <span class="s">{</span></li><li>     <span class="w">dSP</span><span class="sc">;</span></li><li>     <span class="w">SV</span>* <span class="w">retval</span><span class="sc">;</span></li><li>     <span class="w">STRLEN</span> <span class="w">n_a</span><span class="sc">;</span></li><li></li><li>     <span class="i">PUSHMARK</span><span class="s">(</span><span class="w">SP</span><span class="s">)</span><span class="sc">;</span></li><li>     <span class="i">eval_sv</span><span class="s">(</span><span class="w">sv</span><span class="cm">,</span> <span class="w">G_SCALAR</span><span class="s">)</span><span class="sc">;</span></li><li></li><li>     <span class="w">SPAGAIN</span><span class="sc">;</span></li><li>     <span class="w">retval</span> = <span class="w">POPs</span><span class="sc">;</span></li><li>     <span class="w">PUTBACK</span><span class="sc">;</span></li><li></li><li>     if <span class="s">(</span><span class="w">croak_on_error</span> &amp;&amp; <span class="i">SvTRUE</span><span class="s">(</span><span class="w">ERRSV</span><span class="s">)</span><span class="s">)</span></li><li> 	<span class="i">croak</span><span class="s">(</span><span class="i">SvPVx</span><span class="s">(</span><span class="w">ERRSV</span><span class="cm">,</span> <span class="w">n_a</span><span class="s">)</span><span class="s">)</span><span class="sc">;</span></li><li></li><li>     <a class="l_k" href="functions/return.html">return</a> <span class="w">retval</span><span class="sc">;</span></li><li> <span class="s">}</span></li><li></li><li> <span class="q">/** match(string, pattern)</span></li><li> <span class="q"> **</span></li><li> <span class="q"> ** Used for matches in a scalar context.</span></li><li> <span class="q"> **</span></li><li> <span class="q"> ** Returns 1 if the match was successful; 0 otherwise.</span></li><li> <span class="q"> **/</span></li><li></li><li> <span class="w">I32</span> <span class="i">match</span><span class="s">(</span><span class="w">SV</span> *<span class="w">string</span><span class="cm">,</span> <span class="w">char</span> *<span class="w">pattern</span><span class="s">)</span></li><li> <span class="s">{</span></li><li>     <span class="w">SV</span> *<span class="w">command</span> = <span class="i">NEWSV</span><span class="s">(</span><span class="n">1099</span><span class="cm">,</span> <span class="n">0</span><span class="s">)</span><span class="cm">,</span> <span class="i">*retval</span><span class="sc">;</span></li><li>     <span class="w">STRLEN</span> <span class="w">n_a</span><span class="sc">;</span></li><li></li><li>     <span class="i">sv_setpvf</span><span class="s">(</span><span class="w">command</span><span class="cm">,</span> <span class="q">&quot;my $string = &#39;%s&#39;; $string =~ %s&quot;</span><span class="cm">,</span></li><li> 	      <span class="i">SvPV</span><span class="s">(</span><span class="w">string</span><span class="cm">,</span><span class="w">n_a</span><span class="s">)</span><span class="cm">,</span> <span class="w">pattern</span><span class="s">)</span><span class="sc">;</span></li><li></li><li>     <span class="w">retval</span> = <span class="i">my_eval_sv</span><span class="s">(</span><span class="w">command</span><span class="cm">,</span> <span class="w">TRUE</span><span class="s">)</span><span class="sc">;</span></li><li>     <span class="i">SvREFCNT_dec</span><span class="s">(</span><span class="w">command</span><span class="s">)</span><span class="sc">;</span></li><li></li><li>     <a class="l_k" href="functions/return.html">return</a> <span class="i">SvIV</span><span class="s">(</span><span class="w">retval</span><span class="s">)</span><span class="sc">;</span></li><li> <span class="s">}</span></li><li></li><li> <span class="q">/** substitute(string, pattern)</span></li><li> <span class="q"> **</span></li><li> <span class="q"> ** Used for =~ operations that modify their left-hand side (s/</span>// and <span class="q">tr///</span><span class="p">)</span></li><li> **</li><li> <span class="i">**</span> <span class="w">Returns</span> <span class="w">the</span> <span class="w">number</span> <span class="w">of</span> <span class="w">successful</span> <span class="w">matches</span><span class="cm">,</span> and</li><li> <span class="i">**</span> <span class="w">modifies</span> <span class="w">the</span> <span class="w">input</span> <span class="w">string</span> if <span class="w">there</span> <span class="w">were</span> <span class="w">any</span>.</li><li> <span class="i">**</span>/</li><li></li><li> <span class="w">I32</span> <span class="i">substitute</span><span class="s">(</span><span class="w">SV</span> **<span class="w">string</span><span class="cm">,</span> <span class="w">char</span> *<span class="w">pattern</span><span class="s">)</span></li><li> <span class="s">{</span></li><li>     <span class="w">SV</span> *<span class="w">command</span> = <span class="i">NEWSV</span><span class="s">(</span><span class="n">1099</span><span class="cm">,</span> <span class="n">0</span><span class="s">)</span><span class="cm">,</span> <span class="i">*retval</span><span class="sc">;</span></li><li>     <span class="w">STRLEN</span> <span class="w">n_a</span><span class="sc">;</span></li><li></li><li>     <span class="i">sv_setpvf</span><span class="s">(</span><span class="w">command</span><span class="cm">,</span> <span class="q">&quot;$string = &#39;%s&#39;; ($string =~ %s)&quot;</span><span class="cm">,</span></li><li> 	      <span class="i">SvPV</span><span class="s">(</span><span class="i">*string</span><span class="cm">,</span><span class="w">n_a</span><span class="s">)</span><span class="cm">,</span> <span class="w">pattern</span><span class="s">)</span><span class="sc">;</span></li><li></li><li>     <span class="w">retval</span> = <span class="i">my_eval_sv</span><span class="s">(</span><span class="w">command</span><span class="cm">,</span> <span class="w">TRUE</span><span class="s">)</span><span class="sc">;</span></li><li>     <span class="i">SvREFCNT_dec</span><span class="s">(</span><span class="w">command</span><span class="s">)</span><span class="sc">;</span></li><li></li><li>     <span class="i">*string</span> = <span class="i">get_sv</span><span class="s">(</span><span class="q">&quot;string&quot;</span><span class="cm">,</span> <span class="w">FALSE</span><span class="s">)</span><span class="sc">;</span></li><li>     <a class="l_k" href="functions/return.html">return</a> <span class="i">SvIV</span><span class="s">(</span><span class="w">retval</span><span class="s">)</span><span class="sc">;</span></li><li> <span class="s">}</span></li><li></li><li> <span class="q">/** matches(string, pattern, matches)</span></li><li> <span class="q"> **</span></li><li> <span class="q"> ** Used for matches in a list context.</span></li><li> <span class="q"> **</span></li><li> <span class="q"> ** Returns the number of matches,</span></li><li> <span class="q"> ** and fills in **matches with the matching substrings</span></li><li> <span class="q"> **/</span></li><li></li><li> <span class="w">I32</span> <span class="i">matches</span><span class="s">(</span><span class="w">SV</span> *<span class="w">string</span><span class="cm">,</span> <span class="w">char</span> *<span class="w">pattern</span><span class="cm">,</span> <span class="w">AV</span> **<span class="w">match_list</span><span class="s">)</span></li><li> <span class="s">{</span></li><li>     <span class="w">SV</span> *<span class="w">command</span> = <span class="i">NEWSV</span><span class="s">(</span><span class="n">1099</span><span class="cm">,</span> <span class="n">0</span><span class="s">)</span><span class="sc">;</span></li><li>     <span class="w">I32</span> <span class="w">num_matches</span><span class="sc">;</span></li><li>     <span class="w">STRLEN</span> <span class="w">n_a</span><span class="sc">;</span></li><li></li><li>     <span class="i">sv_setpvf</span><span class="s">(</span><span class="w">command</span><span class="cm">,</span> <span class="q">&quot;my $string = &#39;%s&#39;; @array = ($string =~ %s)&quot;</span><span class="cm">,</span></li><li> 	      <span class="i">SvPV</span><span class="s">(</span><span class="w">string</span><span class="cm">,</span><span class="w">n_a</span><span class="s">)</span><span class="cm">,</span> <span class="w">pattern</span><span class="s">)</span><span class="sc">;</span></li><li></li><li>     <span class="i">my_eval_sv</span><span class="s">(</span><span class="w">command</span><span class="cm">,</span> <span class="w">TRUE</span><span class="s">)</span><span class="sc">;</span></li><li>     <span class="i">SvREFCNT_dec</span><span class="s">(</span><span class="w">command</span><span class="s">)</span><span class="sc">;</span></li><li></li><li>     <span class="i">*match_list</span> = <span class="i">get_av</span><span class="s">(</span><span class="q">&quot;array&quot;</span><span class="cm">,</span> <span class="w">FALSE</span><span class="s">)</span><span class="sc">;</span></li><li>     <span class="w">num_matches</span> = <span class="i">av_len</span><span class="s">(</span><span class="i">*match_list</span><span class="s">)</span> + <span class="n">1</span><span class="sc">;</span> <span class="q">/** assume $[ is 0 **/</span></li><li></li><li>     <a class="l_k" href="functions/return.html">return</a> <span class="w">num_matches</span><span class="sc">;</span></li><li> <span class="s">}</span></li><li></li><li> <span class="w">main</span> <span class="s">(</span><a class="l_k" href="functions/int.html">int</a> <span class="w">argc</span><span class="cm">,</span> <span class="w">char</span> **<span class="w">argv</span><span class="cm">,</span> <span class="w">char</span> **<span class="w">env</span><span class="s">)</span></li><li> <span class="s">{</span></li><li>     <span class="w">PerlInterpreter</span> *<span class="w">my_perl</span> = <span class="i">perl_alloc</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span></li><li>     <span class="w">char</span> *<span class="w">embedding</span><span class="s">[</span><span class="s">]</span> = <span class="s">{</span> <span class="q">&quot;&quot;</span><span class="cm">,</span> <span class="q">&quot;-e&quot;</span><span class="cm">,</span> <span class="q">&quot;0&quot;</span> <span class="s">}</span><span class="sc">;</span></li><li>     <span class="w">AV</span> *<span class="w">match_list</span><span class="sc">;</span></li><li>     <span class="w">I32</span> <span class="w">num_matches</span><span class="cm">,</span> <span class="w">i</span><span class="sc">;</span></li><li>     <span class="w">SV</span> *<span class="w">text</span> = <span class="i">NEWSV</span><span class="s">(</span><span class="n">1099</span><span class="cm">,</span><span class="n">0</span><span class="s">)</span><span class="sc">;</span></li><li>     <span class="w">STRLEN</span> <span class="w">n_a</span><span class="sc">;</span></li><li></li><li>     <span class="i">perl_construct</span><span class="s">(</span><span class="w">my_perl</span><span class="s">)</span><span class="sc">;</span></li><li>     <span class="i">perl_parse</span><span class="s">(</span><span class="w">my_perl</span><span class="cm">,</span> <span class="w">NULL</span><span class="cm">,</span> <span class="n">3</span><span class="cm">,</span> <span class="w">embedding</span><span class="cm">,</span> <span class="w">NULL</span><span class="s">)</span><span class="sc">;</span></li><li></li><li>     <span class="i">sv_setpv</span><span class="s">(</span><span class="w">text</span><span class="cm">,</span> <span class="q">&quot;When he is at a convenience store and the bill comes to some amount like 76 cents, Maynard is aware that there is something he *should* do, something that will enable him to get back a quarter, but he has no idea *what*.  He fumbles through his red squeezey changepurse and gives the boy three extra pennies with his dollar, hoping that he might luck into the correct amount.  The boy gives him back two of his own pennies and then the big shiny quarter that is his prize. -RICHH&quot;</span><span class="s">)</span><span class="sc">;</span></li><li></li><li>     if <span class="s">(</span><span class="i">match</span><span class="s">(</span><span class="w">text</span><span class="cm">,</span> <span class="q">&quot;m/quarter/&quot;</span><span class="s">)</span><span class="s">)</span> /<span class="i">**</span> <span class="w">Does</span> <span class="w">text</span> <span class="w">contain</span> <span class="q">&#39;quarter&#39;</span>? <span class="i">**</span>/</li><li> 	<a class="l_k" href="functions/printf.html">printf</a><span class="s">(</span><span class="q">&quot;match: Text contains the word &#39;quarter&#39;.\n\n&quot;</span><span class="s">)</span><span class="sc">;</span></li><li>     else</li><li> 	<a class="l_k" href="functions/printf.html">printf</a><span class="s">(</span><span class="q">&quot;match: Text doesn&#39;t contain the word &#39;quarter&#39;.\n\n&quot;</span><span class="s">)</span><span class="sc">;</span></li><li></li><li>     if <span class="s">(</span><span class="i">match</span><span class="s">(</span><span class="w">text</span><span class="cm">,</span> <span class="q">&quot;m/eighth/&quot;</span><span class="s">)</span><span class="s">)</span> /<span class="i">**</span> <span class="w">Does</span> <span class="w">text</span> <span class="w">contain</span> <span class="q">&#39;eighth&#39;</span>? <span class="i">**</span>/</li><li> 	<a class="l_k" href="functions/printf.html">printf</a><span class="s">(</span><span class="q">&quot;match: Text contains the word &#39;eighth&#39;.\n\n&quot;</span><span class="s">)</span><span class="sc">;</span></li><li>     else</li><li> 	<a class="l_k" href="functions/printf.html">printf</a><span class="s">(</span><span class="q">&quot;match: Text doesn&#39;t contain the word &#39;eighth&#39;.\n\n&quot;</span><span class="s">)</span><span class="sc">;</span></li><li></li><li>     <span class="q">/** Match all occurrences of /</span><span class="w">wi</span>..<span class="q">/ **/</span></li><li>     <span class="w">num_matches</span> = <span class="i">matches</span><span class="s">(</span><span class="w">text</span><span class="cm">,</span> <span class="q">&quot;m/(wi..)/g&quot;</span><span class="cm">,</span> <span class="i">&amp;match_list</span><span class="s">)</span><span class="sc">;</span></li><li>     <a class="l_k" href="functions/printf.html">printf</a><span class="s">(</span><span class="q">&quot;matches: m/(wi..)/g found %d matches...\n&quot;</span><span class="cm">,</span> <span class="w">num_matches</span><span class="s">)</span><span class="sc">;</span></li><li></li><li>     for <span class="s">(</span><span class="w">i</span> = <span class="n">0</span><span class="sc">;</span> <span class="w">i</span> &lt; <span class="w">num_matches</span><span class="sc">;</span> <span class="w">i</span>++<span class="s">)</span></li><li> 	<a class="l_k" href="functions/printf.html">printf</a><span class="s">(</span><span class="q">&quot;match: %s\n&quot;</span><span class="cm">,</span> <span class="i">SvPV</span><span class="s">(</span><span class="i">*av_fetch</span><span class="s">(</span><span class="w">match_list</span><span class="cm">,</span> <span class="w">i</span><span class="cm">,</span> <span class="w">FALSE</span><span class="s">)</span><span class="cm">,</span><span class="w">n_a</span><span class="s">)</span><span class="s">)</span><span class="sc">;</span></li><li>     <a class="l_k" href="functions/printf.html">printf</a><span class="s">(</span><span class="q">&quot;\n&quot;</span><span class="s">)</span><span class="sc">;</span></li><li></li><li>     <span class="q">/** Remove all vowels from text **/</span></li><li>     <span class="w">num_matches</span> = <span class="i">substitute</span><span class="s">(</span><span class="i">&amp;text</span><span class="cm">,</span> <span class="q">&quot;s/[aeiou]//gi&quot;</span><span class="s">)</span><span class="sc">;</span></li><li>     if <span class="s">(</span><span class="w">num_matches</span><span class="s">)</span> <span class="s">{</span></li><li> 	<a class="l_k" href="functions/printf.html">printf</a><span class="s">(</span><span class="q">&quot;substitute: s/[aeiou]//gi...%d substitutions made.\n&quot;</span><span class="cm">,</span></li><li> 	       <span class="w">num_matches</span><span class="s">)</span><span class="sc">;</span></li><li> 	<a class="l_k" href="functions/printf.html">printf</a><span class="s">(</span><span class="q">&quot;Now text is: %s\n\n&quot;</span><span class="cm">,</span> <span class="i">SvPV</span><span class="s">(</span><span class="w">text</span><span class="cm">,</span><span class="w">n_a</span><span class="s">)</span><span class="s">)</span><span class="sc">;</span></li><li>     <span class="s">}</span></li><li></li><li>     <span class="q">/** Attempt a substitution **/</span></li><li>     if <span class="s">(</span>!<span class="i">substitute</span><span class="s">(</span><span class="i">&amp;text</span><span class="cm">,</span> <span class="q">&quot;s/Perl/C/&quot;</span><span class="s">)</span><span class="s">)</span> <span class="s">{</span></li><li> 	<a class="l_k" href="functions/printf.html">printf</a><span class="s">(</span><span class="q">&quot;substitute: s/Perl/C...No substitution made.\n\n&quot;</span><span class="s">)</span><span class="sc">;</span></li><li>     <span class="s">}</span></li><li></li><li>     <span class="i">SvREFCNT_dec</span><span class="s">(</span><span class="w">text</span><span class="s">)</span><span class="sc">;</span></li><li>     <span class="w">PL_perl_destruct_level</span> = <span class="n">1</span><span class="sc">;</span></li><li>     <span class="i">perl_destruct</span><span class="s">(</span><span class="w">my_perl</span><span class="s">)</span><span class="sc">;</span></li><li>     <span class="i">perl_free</span><span class="s">(</span><span class="w">my_perl</span><span class="s">)</span><span class="sc">;</span></li><li> <span class="s">}</span></li></ol></pre><p>which produces the output (again, long lines have been wrapped here)</p>
<pre class="verbatim"><ol><li>   <span class="j">match:</span> <span class="w">Text</span> <span class="w">contains</span> <span class="w">the</span> <span class="w">word</span> <span class="q">&#39;quarter&#39;</span>.</li><li></li><li>   <span class="w">match</span><span class="co">:</span> <span class="w">Text</span> <span class="w">doesn&#39;t</span> <span class="w">contain</span> <span class="w">the</span> <span class="w">word</span> <span class="q">&#39;eighth&#39;</span>.</li><li></li><li>   <span class="w">matches</span><span class="co">:</span> <span class="q">m/(wi..)/g</span> <span class="w">found</span> <span class="n">2</span> <span class="w">matches</span>...</li><li>   <span class="w">match</span><span class="co">:</span> <span class="w">will</span></li><li>   <span class="w">match</span><span class="co">:</span> <span class="w">with</span></li><li></li><li>   <span class="w">substitute</span><span class="co">:</span> <span class="q">s/[aeiou]//gi</span>...<span class="n">139</span> <span class="w">substitutions</span> <span class="w">made</span>.</li><li>   <span class="w">Now</span> <span class="w">text</span> <span class="w">is</span><span class="co">:</span> <span class="w">Whn</span> <span class="w">h</span> <span class="q">s t  cnvnnc str nd th</span> <span class="w">bll</span> <span class="w">cms</span> <span class="w">t</span> <span class="w">sm</span> <span class="w">mnt</span> <span class="w">lk</span> <span class="n">76</span> <span class="w">cnts</span><span class="cm">,</span></li><li>   <span class="w">Mynrd</span> <span class="q">s wr tht thr s smthng h *shld* d, smthng tht wll nbl hm t gt bck</span></li><li>   <span class="q">   qrtr, bt h hs n d *wht</span>*.  <span class="w">H</span> <span class="w">fmbls</span> <span class="w">thrgh</span> <span class="w">hs</span> <span class="w">rd</span> <span class="w">sqzy</span> <span class="w">chngprs</span> <span class="w">nd</span> <span class="w">gvs</span> <span class="w">th</span> <span class="w">by</span></li><li>   <span class="w">thr</span> <span class="w">xtr</span> <span class="w">pnns</span> <span class="w">wth</span> <span class="w">hs</span> <span class="w">dllr</span><span class="cm">,</span> <span class="w">hpng</span> <span class="w">tht</span> <span class="w">h</span> <span class="w">mght</span> <span class="w">lck</span> <span class="w">nt</span> <span class="w">th</span> <span class="w">crrct</span> <span class="w">mnt</span>.  <span class="w">Th</span> <span class="w">by</span> <span class="w">gvs</span></li><li>   <span class="w">hm</span> <span class="w">bck</span> <span class="w">tw</span> <span class="w">f</span> <span class="w">hs</span> <span class="w">wn</span> <span class="w">pnns</span> <span class="w">nd</span> <span class="w">thn</span> <span class="w">th</span> <span class="w">bg</span> <span class="w">shny</span> <span class="w">qrtr</span> <span class="w">tht</span> <span class="q">s hs prz. -RCHH</span></li><li></li><li>   <span class="q">   substitute: s/Perl/C...No substitution made.</span></li></ol></pre><a class='view-head2' id="Fiddling-with-the-Perl-stack-from-your-C-program"></a><h3 class='h3' >Fiddling with the Perl stack from your C program</h3>
<p>When trying to explain stacks, most computer science textbooks mumble
something about spring-loaded columns of cafeteria plates: the last
thing you pushed on the stack is the first thing you pop off.  That'll
do for our purposes: your C program will push some arguments onto "the Perl
stack", shut its eyes while some magic happens, and then pop the
results--the return value of your Perl subroutine--off the stack.</p>
<p>First you'll need to know how to convert between C types and Perl
types, with newSViv() and sv_setnv() and newAV() and all their
friends.  They're described in <a href="perlguts.html">perlguts</a> and <a href="perlapi.html">perlapi</a>.</p>
<p>Then you'll need to know how to manipulate the Perl stack.  That's
described in <a href="perlcall.html">perlcall</a>.</p>
<p>Once you've understood those, embedding Perl in C is easy.</p>
<p>Because C has no builtin function for integer exponentiation, let's
make Perl's ** operator available to it (this is less useful than it
sounds, because Perl implements ** with C's <i>pow()</i> function).  First
I'll create a stub exponentiation function in <i>power.pl</i>:</p>
<pre class="verbatim"><ol><li><a name="expo"></a>    sub <span class="m">expo</span> <span class="s">{</span></li><li>        <a class="l_k" href="functions/my.html">my</a> <span class="s">(</span><span class="i">$a</span><span class="cm">,</span> <span class="i">$b</span><span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span></li><li>        <a class="l_k" href="functions/return.html">return</a> <span class="i">$a</span> ** <span class="i">$b</span><span class="sc">;</span></li><li>    <span class="s">}</span></li></ol></pre><p>Now I'll create a C program, <i>power.c</i>, with a function
<i>PerlPower()</i> that contains all the perlguts necessary to push the
two arguments into <i>expo()</i> and to pop the return value out.  Take a
deep breath...</p>
<pre class="verbatim"><ol><li>    <span class="c">#include &lt;EXTERN.h&gt;</span></li><li>    <span class="c">#include &lt;perl.h&gt;</span></li><li></li><li>    <span class="w">static</span> <span class="w">PerlInterpreter</span> *<span class="w">my_perl</span><span class="sc">;</span></li><li></li><li>    <span class="w">static</span> <span class="w">void</span></li><li>    <span class="i">PerlPower</span><span class="s">(</span><a class="l_k" href="functions/int.html">int</a> <span class="w">a</span><span class="cm">,</span> <a class="l_k" href="functions/int.html">int</a> <span class="w">b</span><span class="s">)</span></li><li>    <span class="s">{</span></li><li>      <span class="w">dSP</span><span class="sc">;</span>                            <span class="q">/* initialize stack pointer      */</span></li><li>      <span class="w">ENTER</span><span class="sc">;</span>                          <span class="q">/* everything created after here */</span></li><li>      <span class="w">SAVETMPS</span><span class="sc">;</span>                       <span class="q">/* ...is a temporary variable.   */</span></li><li>      <span class="i">PUSHMARK</span><span class="s">(</span><span class="w">SP</span><span class="s">)</span><span class="sc">;</span>                   <span class="q">/* remember the stack pointer    */</span></li><li>      <span class="i">XPUSHs</span><span class="s">(</span><span class="i">sv_2mortal</span><span class="s">(</span><span class="i">newSViv</span><span class="s">(</span><span class="w">a</span><span class="s">)</span><span class="s">)</span><span class="s">)</span><span class="sc">;</span> <span class="q">/* push the base onto the stack  */</span></li><li>      <span class="i">XPUSHs</span><span class="s">(</span><span class="i">sv_2mortal</span><span class="s">(</span><span class="i">newSViv</span><span class="s">(</span><span class="w">b</span><span class="s">)</span><span class="s">)</span><span class="s">)</span><span class="sc">;</span> <span class="q">/* push the exponent onto stack  */</span></li><li>      <span class="w">PUTBACK</span><span class="sc">;</span>                      <span class="q">/* make local stack pointer global */</span></li><li>      <span class="i">call_pv</span><span class="s">(</span><span class="q">&quot;expo&quot;</span><span class="cm">,</span> <span class="w">G_SCALAR</span><span class="s">)</span><span class="sc">;</span>      <span class="q">/* call the function             */</span></li><li>      <span class="w">SPAGAIN</span><span class="sc">;</span>                        <span class="q">/* refresh stack pointer         */</span></li><li>                                    /<span class="i">* pop</span> <span class="w">the</span> <a class="l_k" href="functions/return.html">return</a> <span class="w">value</span> <span class="w">from</span> <span class="w">stack</span> *<span class="q">/</span></li><li>      <span class="q">      printf (&quot;%d to the %dth power is %d.\n&quot;, a, b, POPi);</span></li><li>      <span class="q">      PUTBACK;</span></li><li>      <span class="q">      FREETMPS;                       /</span>* <span class="w">free</span> <span class="w">that</span> <a class="l_k" href="functions/return.html">return</a> <span class="w">value</span>        *<span class="q">/</span></li><li>      <span class="q">      LEAVE;                       /</span>* ...and <span class="w">the</span> <span class="w">XPUSHed</span> <span class="q">&quot;mortal&quot;</span> <span class="w">args</span>.<span class="i">*/</span></li><li>    <span class="s">}</span></li><li></li><li>    <a class="l_k" href="functions/int.html">int</a> <span class="w">main</span> <span class="s">(</span><a class="l_k" href="functions/int.html">int</a> <span class="w">argc</span><span class="cm">,</span> <span class="w">char</span> **<span class="w">argv</span><span class="cm">,</span> <span class="w">char</span> **<span class="w">env</span><span class="s">)</span></li><li>    <span class="s">{</span></li><li>      <span class="w">char</span> *<span class="w">my_argv</span><span class="s">[</span><span class="s">]</span> = <span class="s">{</span> <span class="q">&quot;&quot;</span><span class="cm">,</span> <span class="q">&quot;power.pl&quot;</span> <span class="s">}</span><span class="sc">;</span></li><li></li><li>      <span class="w">my_perl</span> = <span class="i">perl_alloc</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span></li><li>      <span class="i">perl_construct</span><span class="s">(</span> <span class="w">my_perl</span> <span class="s">)</span><span class="sc">;</span></li><li></li><li>      <span class="i">perl_parse</span><span class="s">(</span><span class="w">my_perl</span><span class="cm">,</span> <span class="w">NULL</span><span class="cm">,</span> <span class="n">2</span><span class="cm">,</span> <span class="w">my_argv</span><span class="cm">,</span> <span class="s">(</span><span class="w">char</span> **<span class="s">)</span><span class="w">NULL</span><span class="s">)</span><span class="sc">;</span></li><li>      <span class="i">perl_run</span><span class="s">(</span><span class="w">my_perl</span><span class="s">)</span><span class="sc">;</span></li><li></li><li>      <span class="i">PerlPower</span><span class="s">(</span><span class="n">3</span><span class="cm">,</span> <span class="n">4</span><span class="s">)</span><span class="sc">;</span>                      <span class="q">/*** Compute 3 ** 4 ***/</span></li><li></li><li>      <span class="i">perl_destruct</span><span class="s">(</span><span class="w">my_perl</span><span class="s">)</span><span class="sc">;</span></li><li>      <span class="i">perl_free</span><span class="s">(</span><span class="w">my_perl</span><span class="s">)</span><span class="sc">;</span></li><li>    <span class="s">}</span></li></ol></pre><p>Compile and run:</p>
<pre class="verbatim"><ol><li>    <span class="i">% cc</span> -<span class="w">o</span> <span class="w">power</span> <span class="w">power</span>.<span class="w">c</span> <span class="q">`perl -MExtUtils::Embed -e ccopts -e ldopts`</span></li><li></li><li>    % <span class="w">power</span></li><li>    <span class="n">3</span> <span class="w">to</span> <span class="w">the</span> <span class="n">4</span><span class="w">th</span> <span class="w">power</span> <span class="w">is</span> <span class="n">81.</span></li></ol></pre><a class='view-head2' id="Maintaining-a-persistent-interpreter"></a><h3 class='h3' >Maintaining a persistent interpreter</h3>
<p>When developing interactive and/or potentially long-running
applications, it's a good idea to maintain a persistent interpreter
rather than allocating and constructing a new interpreter multiple
times.  The major reason is speed: since Perl will only be loaded into
memory once.</p>
<p>However, you have to be more cautious with namespace and variable
scoping when using a persistent interpreter.  In previous examples
we've been using global variables in the default package <code class="inline"><span class="w">main</span></code>
.  We
knew exactly what code would be run, and assumed we could avoid
variable collisions and outrageous symbol table growth.</p>
<p>Let's say your application is a server that will occasionally run Perl
code from some arbitrary file.  Your server has no way of knowing what
code it's going to run.  Very dangerous.</p>
<p>If the file is pulled in by <code class="inline"><span class="i">perl_parse</span><span class="s">(</span><span class="s">)</span></code>
, compiled into a newly
constructed interpreter, and subsequently cleaned out with
<code class="inline"><span class="i">perl_destruct</span><span class="s">(</span><span class="s">)</span></code>
 afterwards, you're shielded from most namespace
troubles.</p>
<p>One way to avoid namespace collisions in this scenario is to translate
the filename into a guaranteed-unique package name, and then compile
the code into that package using <a class='function-name' href="functions/eval.html">eval</a>.  In the example
below, each file will only be compiled once.  Or, the application
might choose to clean out the symbol table associated with the file
after it's no longer needed.  Using <a href="perlapi.html#call_argv">call_argv in perlapi</a>, We'll
call the subroutine <code class="inline"><span class="w">Embed::Persistent::eval_file</span></code>
 which lives in the
file <code class="inline"><span class="w">persistent</span>.<span class="w">pl</span></code>
 and pass the filename and boolean cleanup/cache
flag as arguments.</p>
<p>Note that the process will continue to grow for each file that it
uses.  In addition, there might be <code class="inline">AUTOLOAD</code>
ed subroutines and other
conditions that cause Perl's symbol table to grow.  You might want to
add some logic that keeps track of the process size, or restarts
itself after a certain number of requests, to ensure that memory
consumption is minimized.  You'll also want to scope your variables
with <a class='function-name' href="functions/my.html">my</a> whenever possible.</p>
<pre class="verbatim"><ol><li><a name="package-Embed::Persistent"></a> package <span class="i">Embed::Persistent</span><span class="sc">;</span></li><li> <span class="c">#persistent.pl</span></li><li></li><li> <a class="l_k" href="functions/use.html">use</a> <span class="w">strict</span><span class="sc">;</span></li><li> <a class="l_k" href="functions/our.html">our</a> <span class="i">%Cache</span><span class="sc">;</span></li><li> <a class="l_k" href="functions/use.html">use</a> <span class="w">Symbol</span> <span class="q">qw(delete_package)</span><span class="sc">;</span></li><li></li><li><a name="valid_package_name"></a> sub <span class="m">valid_package_name</span> <span class="s">{</span></li><li>     <a class="l_k" href="functions/my.html">my</a><span class="s">(</span><span class="i">$string</span><span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span></li><li>     <span class="i">$string</span> =~ <span class="q">s/([^A-Za-z0-9\/])/sprintf(&quot;_%2x&quot;,unpack(&quot;C&quot;,$1))/eg</span><span class="sc">;</span></li><li>     <span class="c"># second pass only for words starting with a digit</span></li><li>     <span class="i">$string</span> =~ <span class="q">s|/(\d)|sprintf(&quot;/_%2x&quot;,unpack(&quot;C&quot;,$1))|eg</span><span class="sc">;</span></li><li></li><li>     <span class="c"># Dress it up as a real package name</span></li><li>     <span class="i">$string</span> =~ <span class="q">s|/|::|g</span><span class="sc">;</span></li><li>     <a class="l_k" href="functions/return.html">return</a> <span class="q">&quot;Embed&quot;</span> . <span class="i">$string</span><span class="sc">;</span></li><li> <span class="s">}</span></li><li></li><li><a name="eval_file"></a> sub <span class="m">eval_file</span> <span class="s">{</span></li><li>     <a class="l_k" href="functions/my.html">my</a><span class="s">(</span><span class="i">$filename</span><span class="cm">,</span> <span class="i">$delete</span><span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span></li><li>     <a class="l_k" href="functions/my.html">my</a> <span class="i">$package</span> = <span class="i">valid_package_name</span><span class="s">(</span><span class="i">$filename</span><span class="s">)</span><span class="sc">;</span></li><li>     <a class="l_k" href="functions/my.html">my</a> <span class="i">$mtime</span> = -M <span class="i">$filename</span><span class="sc">;</span></li><li>     if<span class="s">(</span><a class="l_k" href="functions/defined.html">defined</a> <span class="i">$Cache</span>{<span class="i">$package</span>}{<span class="w">mtime</span>}</li><li>        &amp;&amp;</li><li>        <span class="i">$Cache</span>{<span class="i">$package</span>}{<span class="w">mtime</span>} &lt;= <span class="i">$mtime</span><span class="s">)</span></li><li>     <span class="s">{</span></li><li>        <span class="c"># we have compiled this subroutine already,</span></li><li>        <span class="c"># it has not been updated on disk, nothing left to do</span></li><li>        <a class="l_k" href="functions/print.html">print</a> <span class="i">STDERR</span> <span class="q">&quot;already compiled $package-&gt;handler\n&quot;</span><span class="sc">;</span></li><li>     <span class="s">}</span></li><li>     else <span class="s">{</span></li><li>        <a class="l_k" href="functions/local.html">local</a> <span class="i">*FH</span><span class="sc">;</span></li><li>        <a class="l_k" href="functions/open.html">open</a> <span class="w">FH</span><span class="cm">,</span> <span class="i">$filename</span> or <a class="l_k" href="functions/die.html">die</a> <span class="q">&quot;open &#39;$filename&#39; $!&quot;</span><span class="sc">;</span></li><li>        <a class="l_k" href="functions/local.html">local</a><span class="s">(</span><span class="i">$/</span><span class="s">)</span> = <a class="l_k" href="functions/undef.html">undef</a><span class="sc">;</span></li><li>        <a class="l_k" href="functions/my.html">my</a> <span class="i">$sub</span> = <span class="q">&lt;FH&gt;</span><span class="sc">;</span></li><li>        <a class="l_k" href="functions/close.html">close</a> <span class="w">FH</span><span class="sc">;</span></li><li></li><li>        <span class="c">#wrap the code into a subroutine inside our unique package</span></li><li>        <a class="l_k" href="functions/my.html">my</a> <span class="i">$eval</span> = <span class="q">qq{package $package; sub handler { $sub; }}</span><span class="sc">;</span></li><li>        <span class="s">{</span></li><li>            <span class="c"># hide our variables within this block</span></li><li>            <a class="l_k" href="functions/my.html">my</a><span class="s">(</span><span class="i">$filename</span><span class="cm">,</span><span class="i">$mtime</span><span class="cm">,</span><span class="i">$package</span><span class="cm">,</span><span class="i">$sub</span><span class="s">)</span><span class="sc">;</span></li><li>            <a class="l_k" href="functions/eval.html">eval</a> <span class="i">$eval</span><span class="sc">;</span></li><li>        <span class="s">}</span></li><li>        <a class="l_k" href="functions/die.html">die</a> <span class="i">$@</span> if <span class="i">$@</span><span class="sc">;</span></li><li></li><li>        <span class="c">#cache it unless we&#39;re cleaning out each time</span></li><li>        <span class="i">$Cache</span>{<span class="i">$package</span>}{<span class="w">mtime</span>} = <span class="i">$mtime</span> unless <span class="i">$delete</span><span class="sc">;</span></li><li>     <span class="s">}</span></li><li></li><li>     <a class="l_k" href="functions/eval.html">eval</a> <span class="s">{</span><span class="i">$package</span><span class="i">-&gt;handler</span><span class="sc">;</span><span class="s">}</span><span class="sc">;</span></li><li>     <a class="l_k" href="functions/die.html">die</a> <span class="i">$@</span> if <span class="i">$@</span><span class="sc">;</span></li><li></li><li>     <span class="i">delete_package</span><span class="s">(</span><span class="i">$package</span><span class="s">)</span> if <span class="i">$delete</span><span class="sc">;</span></li><li></li><li>     <span class="c">#take a look if you want</span></li><li>     <span class="c">#print Devel::Symdump-&gt;rnew($package)-&gt;as_string, $/;</span></li><li> <span class="s">}</span></li><li></li><li> <span class="n">1</span><span class="sc">;</span></li><li></li><li><a name="__END__"></a> __END__</li><li></li><li><span class="q"> /* persistent.c */</span></li><li><span class="q"> #include &lt;EXTERN.h&gt;</span></li><li><span class="q"> #include &lt;perl.h&gt;</span></li><li></li><li><span class="q"> /* 1 = clean out filename&#39;s symbol table after each request, 0 = don&#39;t */</span></li><li><span class="q"> #ifndef DO_CLEAN</span></li><li><span class="q"> #define DO_CLEAN 0</span></li><li><span class="q"> #endif</span></li><li></li><li><span class="q"> static PerlInterpreter *perl = NULL;</span></li><li></li><li><span class="q"> int</span></li><li><span class="q"> main(int argc, char **argv, char **env)</span></li><li><span class="q"> {</span></li><li><span class="q">     char *embedding[] = { &quot;&quot;, &quot;persistent.pl&quot; };</span></li><li><span class="q">     char *args[] = { &quot;&quot;, DO_CLEAN, NULL };</span></li><li><span class="q">     char filename [1024];</span></li><li><span class="q">     int exitstatus = 0;</span></li><li><span class="q">     STRLEN n_a;</span></li><li></li><li><span class="q">     if((perl = perl_alloc()) == NULL) {</span></li><li><span class="q">        fprintf(stderr, &quot;no memory!&quot;);</span></li><li><span class="q">        exit(1);</span></li><li><span class="q">     }</span></li><li><span class="q">     perl_construct(perl);</span></li><li></li><li><span class="q">     exitstatus = perl_parse(perl, NULL, 2, embedding, NULL);</span></li><li></li><li><span class="q">     if(!exitstatus) {</span></li><li><span class="q">        exitstatus = perl_run(perl);</span></li><li></li><li><span class="q">        while(printf(&quot;Enter file name: &quot;) &amp;&amp; gets(filename)) {</span></li><li></li><li><span class="q">            /* call the subroutine, passing it the filename as an argument */</span></li><li><span class="q">            args[0] = filename;</span></li><li><span class="q">            call_argv(&quot;Embed::Persistent::eval_file&quot;,</span></li><li><span class="q">                           G_DISCARD | G_EVAL, args);</span></li><li></li><li><span class="q">            /* check $@ */</span></li><li><span class="q">            if(SvTRUE(ERRSV))</span></li><li><span class="q">                fprintf(stderr, &quot;eval error: %s\n&quot;, SvPV(ERRSV,n_a));</span></li><li><span class="q">        }</span></li><li><span class="q">     }</span></li><li></li><li><span class="q">     PL_perl_destruct_level = 0;</span></li><li><span class="q">     perl_destruct(perl);</span></li><li><span class="q">     perl_free(perl);</span></li><li><span class="q">     exit(exitstatus);</span></li><li><span class="q"> }</span></li></ol></pre><p>Now compile:</p>
<pre class="verbatim"><ol><li> <span class="i">% cc</span> -<span class="w">o</span> <span class="w">persistent</span> <span class="w">persistent</span>.<span class="w">c</span> <span class="q">`perl -MExtUtils::Embed -e ccopts -e ldopts`</span></li></ol></pre><p>Here's a example script file:</p>
<pre class="verbatim"><ol><li> <span class="c">#test.pl</span></li><li> <a class="l_k" href="functions/my.html">my</a> <span class="i">$string</span> = <span class="q">&quot;hello&quot;</span><span class="sc">;</span></li><li> <span class="i">foo</span><span class="s">(</span><span class="i">$string</span><span class="s">)</span><span class="sc">;</span></li><li></li><li><a name="foo"></a> sub <span class="m">foo</span> <span class="s">{</span></li><li>     <a class="l_k" href="functions/print.html">print</a> <span class="q">&quot;foo says: @_\n&quot;</span><span class="sc">;</span></li><li> <span class="s">}</span></li></ol></pre><p>Now run:</p>
<pre class="verbatim"><ol><li> <span class="i">% persistent</span></li><li> <span class="w">Enter</span> <span class="w">file</span> <span class="w">name</span><span class="co">:</span> <span class="w">test</span>.<span class="w">pl</span></li><li> <span class="w">foo</span> <span class="w">says</span><span class="co">:</span> <span class="w">hello</span></li><li> <span class="w">Enter</span> <span class="w">file</span> <span class="w">name</span><span class="co">:</span> <span class="w">test</span>.<span class="w">pl</span></li><li> <span class="w">already</span> <span class="w">compiled</span> <span class="w">Embed::test_2epl</span><span class="w">-&gt;handler</span></li><li> <span class="w">foo</span> <span class="w">says</span><span class="co">:</span> <span class="w">hello</span></li><li> <span class="w">Enter</span> <span class="w">file</span> <span class="w">name</span><span class="co">:</span> ^<span class="w">C</span></li></ol></pre><a class='view-head2' id="Maintaining-multiple-interpreter-instances"></a><h3 class='h3' >Maintaining multiple interpreter instances</h3>
<p>Some rare applications will need to create more than one interpreter
during a session.  Such an application might sporadically decide to
release any resources associated with the interpreter.</p>
<p>The program must take care to ensure that this takes place <i>before</i>
the next interpreter is constructed.  By default, when perl is not
built with any special options, the global variable
<code class="inline"><span class="w">PL_perl_destruct_level</span></code>
 is set to <code class="inline"><span class="n">0</span></code>
, since extra cleaning isn't
usually needed when a program only ever creates a single interpreter
in its entire lifetime.</p>
<p>Setting <code class="inline"><span class="w">PL_perl_destruct_level</span></code>
 to <code class="inline"><span class="n">1</span></code>
 makes everything squeaky clean:</p>
<pre class="verbatim"><ol><li> <span class="w">PL_perl_destruct_level</span> = <span class="n">1</span><span class="sc">;</span></li><li></li><li> while<span class="s">(</span><span class="n">1</span><span class="s">)</span> <span class="s">{</span></li><li>     ...</li><li>     <span class="q">/* reset global variables here with PL_perl_destruct_level = 1 */</span></li><li>     <span class="i">perl_construct</span><span class="s">(</span><span class="w">my_perl</span><span class="s">)</span><span class="sc">;</span></li><li>     ...</li><li>     <span class="q">/* clean and reset _everything_ during perl_destruct */</span></li><li>     <span class="i">perl_destruct</span><span class="s">(</span><span class="w">my_perl</span><span class="s">)</span><span class="sc">;</span></li><li>     <span class="i">perl_free</span><span class="s">(</span><span class="w">my_perl</span><span class="s">)</span><span class="sc">;</span></li><li>     ...</li><li>     <span class="q">/* let&#39;s go do it again! */</span></li><li> <span class="s">}</span></li></ol></pre><p>When <i>perl_destruct()</i> is called, the interpreter's syntax parse tree
and symbol tables are cleaned up, and global variables are reset.</p>
<p>Now suppose we have more than one interpreter instance running at the
same time.  This is feasible, but only if you used the Configure option
<code class="inline">-<span class="w">Dusemultiplicity</span></code>
 or the options <code class="inline">-<span class="w">Dusethreads</span> -<span class="w">Duseithreads</span></code>
 when
building Perl.  By default, enabling one of these Configure options
sets the per-interpreter global variable <code class="inline"><span class="w">PL_perl_destruct_level</span></code>
 to
<code class="inline"><span class="n">1</span></code>
, so that thorough cleaning is automatic.</p>
<p>Using <code class="inline">-<span class="w">Dusethreads</span> -<span class="w">Duseithreads</span></code>
 rather than <code class="inline">-<span class="w">Dusemultiplicity</span></code>

is more appropriate if you intend to run multiple interpreters
concurrently in different threads, because it enables support for
linking in the thread libraries of your system with the interpreter.</p>
<p>Let's give it a try:</p>
<pre class="verbatim"><ol><li> <span class="c">#include &lt;EXTERN.h&gt;</span></li><li> <span class="c">#include &lt;perl.h&gt;</span></li><li></li><li> <span class="q">/* we&#39;re going to embed two interpreters */</span></li><li> /<span class="i">* we&#39;re</span> <span class="w">going</span> <span class="w">to</span> <span class="w">embed</span> <span class="w">two</span> <span class="w">interpreters</span> *<span class="q">/</span></li><li></li><li> <span class="q"> #define SAY_HELLO &quot;-e&quot;, &quot;print qq(Hi, I&#39;m $^X\n)&quot;</span></li><li></li><li> <span class="q"> int main(int argc, char **argv, char **env)</span></li><li> <span class="q"> {</span></li><li>     <span class="q">     PerlInterpreter</span></li><li>         <span class="q">         *one_perl = perl_alloc(),</span></li><li>         <span class="q">         *two_perl = perl_alloc();</span></li><li>     <span class="q">     char *one_args[] = { &quot;one_perl&quot;, SAY_HELLO };</span></li><li>     <span class="q">     char *two_args[] = { &quot;two_perl&quot;, SAY_HELLO };</span></li><li></li><li>     <span class="q">     PERL_SET_CONTEXT(one_perl);</span></li><li>     <span class="q">     perl_construct(one_perl);</span></li><li>     <span class="q">     PERL_SET_CONTEXT(two_perl);</span></li><li>     <span class="q">     perl_construct(two_perl);</span></li><li></li><li>     <span class="q">     PERL_SET_CONTEXT(one_perl);</span></li><li>     <span class="q">     perl_parse(one_perl, NULL, 3, one_args, (char **)NULL);</span></li><li>     <span class="q">     PERL_SET_CONTEXT(two_perl);</span></li><li>     <span class="q">     perl_parse(two_perl, NULL, 3, two_args, (char **)NULL);</span></li><li></li><li>     <span class="q">     PERL_SET_CONTEXT(one_perl);</span></li><li>     <span class="q">     perl_run(one_perl);</span></li><li>     <span class="q">     PERL_SET_CONTEXT(two_perl);</span></li><li>     <span class="q">     perl_run(two_perl);</span></li><li></li><li>     <span class="q">     PERL_SET_CONTEXT(one_perl);</span></li><li>     <span class="q">     perl_destruct(one_perl);</span></li><li>     <span class="q">     PERL_SET_CONTEXT(two_perl);</span></li><li>     <span class="q">     perl_destruct(two_perl);</span></li><li></li><li>     <span class="q">     PERL_SET_CONTEXT(one_perl);</span></li><li>     <span class="q">     perl_free(one_perl);</span></li><li>     <span class="q">     PERL_SET_CONTEXT(two_perl);</span></li><li>     <span class="q">     perl_free(two_perl);</span></li><li> <span class="q"> }</span></li></ol></pre><p>Note the calls to PERL_SET_CONTEXT().  These are necessary to initialize
the global state that tracks which interpreter is the "current" one on
the particular process or thread that may be running it.  It should
always be used if you have more than one interpreter and are making
perl API calls on both interpreters in an interleaved fashion.</p>
<p>PERL_SET_CONTEXT(interp) should also be called whenever <code class="inline"><span class="w">interp</span></code>
 is
used by a thread that did not create it (using either perl_alloc(), or
the more esoteric perl_clone()).</p>
<p>Compile as usual:</p>
<pre class="verbatim"><ol><li> <span class="i">% cc</span> -<span class="w">o</span> <span class="w">multiplicity</span> <span class="w">multiplicity</span>.<span class="w">c</span> <span class="q">`perl -MExtUtils::Embed -e ccopts -e ldopts`</span></li></ol></pre><p>Run it, Run it:</p>
<pre class="verbatim"><ol><li> <span class="i">% multiplicity</span></li><li> <span class="w">Hi</span><span class="cm">,</span> <span class="w">I&#39;m</span> <span class="w">one_perl</span></li><li> <span class="w">Hi</span><span class="cm">,</span> <span class="w">I&#39;m</span> <span class="w">two_perl</span></li></ol></pre><a class='view-head2' id="Using-Perl-modules%2c-which-themselves-use-C-libraries%2c-from-your-C-program"></a><h3 class='h3' >Using Perl modules, which themselves use C libraries, from your C program</h3>
<p>If you've played with the examples above and tried to embed a script
that <i>use()</i>s a Perl module (such as <i>Socket</i>) which itself uses a C or C++ library,
this probably happened:</p>
<pre class="verbatim"><ol><li> <span class="w">Can&#39;t</span> <span class="w">load</span> <span class="w">module</span> <span class="w">Socket</span><span class="cm">,</span> <span class="w">dynamic</span> <span class="w">loading</span> not <span class="w">available</span> <span class="w">in</span> <span class="w">this</span> <span class="w">perl</span>.</li><li>  <span class="s">(</span><span class="w">You</span> <span class="w">may</span> <span class="w">need</span> <span class="w">to</span> <span class="w">build</span> <span class="w">a</span> <span class="w">new</span> <span class="w">perl</span> <span class="w">executable</span> <span class="w">which</span> <span class="w">either</span> <span class="w">supports</span></li><li>  <span class="w">dynamic</span> <span class="w">loading</span> or <span class="w">has</span> <span class="w">the</span> <span class="w">Socket</span> <span class="w">module</span> <span class="w">statically</span> <span class="w">linked</span> <span class="w">into</span> <span class="w">it</span>.<span class="s">)</span></li></ol></pre><p>What's wrong?</p>
<p>Your interpreter doesn't know how to communicate with these extensions
on its own.  A little glue will help.  Up until now you've been
calling <i>perl_parse()</i>, handing it NULL for the second argument:</p>
<pre class="verbatim"><ol><li> <span class="i">perl_parse</span><span class="s">(</span><span class="w">my_perl</span><span class="cm">,</span> <span class="w">NULL</span><span class="cm">,</span> <span class="w">argc</span><span class="cm">,</span> <span class="w">my_argv</span><span class="cm">,</span> <span class="w">NULL</span><span class="s">)</span><span class="sc">;</span></li></ol></pre><p>That's where the glue code can be inserted to create the initial contact between
Perl and linked C/C++ routines.  Let's take a look some pieces of <i>perlmain.c</i>
to see how Perl does this:</p>
<pre class="verbatim"><ol><li> <span class="w">static</span> <span class="w">void</span> <span class="w">xs_init</span> <span class="s">(</span><span class="w">pTHX</span><span class="s">)</span><span class="sc">;</span></li><li></li><li> <span class="w">EXTERN_C</span> <span class="w">void</span> <span class="w">boot_DynaLoader</span> <span class="s">(</span><span class="w">pTHX_</span> <span class="w">CV</span>* <span class="w">cv</span><span class="s">)</span><span class="sc">;</span></li><li> <span class="w">EXTERN_C</span> <span class="w">void</span> <span class="w">boot_Socket</span> <span class="s">(</span><span class="w">pTHX_</span> <span class="w">CV</span>* <span class="w">cv</span><span class="s">)</span><span class="sc">;</span></li><li></li><li></li><li> <span class="w">EXTERN_C</span> <span class="w">void</span></li><li> <span class="i">xs_init</span><span class="s">(</span><span class="w">pTHX</span><span class="s">)</span></li><li> <span class="s">{</span></li><li>        <span class="w">char</span> *<span class="w">file</span> = <span class="w">__FILE__</span><span class="sc">;</span></li><li>        <span class="q">/* DynaLoader is a special case */</span></li><li>        <span class="i">newXS</span><span class="s">(</span><span class="q">&quot;DynaLoader::boot_DynaLoader&quot;</span><span class="cm">,</span> <span class="w">boot_DynaLoader</span><span class="cm">,</span> <span class="w">file</span><span class="s">)</span><span class="sc">;</span></li><li>        <span class="i">newXS</span><span class="s">(</span><span class="q">&quot;Socket::bootstrap&quot;</span><span class="cm">,</span> <span class="w">boot_Socket</span><span class="cm">,</span> <span class="w">file</span><span class="s">)</span><span class="sc">;</span></li><li> <span class="s">}</span></li></ol></pre><p>Simply put: for each extension linked with your Perl executable
(determined during its initial configuration on your
computer or when adding a new extension),
a Perl subroutine is created to incorporate the extension's
routines.  Normally, that subroutine is named
<i>Module::bootstrap()</i> and is invoked when you say <i>use Module</i>.  In
turn, this hooks into an XSUB, <i>boot_Module</i>, which creates a Perl
counterpart for each of the extension's XSUBs.  Don't worry about this
part; leave that to the <i>xsubpp</i> and extension authors.  If your
extension is dynamically loaded, DynaLoader creates <i>Module::bootstrap()</i>
for you on the fly.  In fact, if you have a working DynaLoader then there
is rarely any need to link in any other extensions statically.</p>
<p>Once you have this code, slap it into the second argument of <i>perl_parse()</i>:</p>
<pre class="verbatim"><ol><li> <span class="i">perl_parse</span><span class="s">(</span><span class="w">my_perl</span><span class="cm">,</span> <span class="w">xs_init</span><span class="cm">,</span> <span class="w">argc</span><span class="cm">,</span> <span class="w">my_argv</span><span class="cm">,</span> <span class="w">NULL</span><span class="s">)</span><span class="sc">;</span></li></ol></pre><p>Then compile:</p>
<pre class="verbatim"><ol><li> <span class="i">% cc</span> -<span class="w">o</span> <span class="w">interp</span> <span class="w">interp</span>.<span class="w">c</span> <span class="q">`perl -MExtUtils::Embed -e ccopts -e ldopts`</span></li><li></li><li> % <span class="w">interp</span></li><li>   <a class="l_k" href="functions/use.html">use</a> <span class="w">Socket</span><span class="sc">;</span></li><li>   <a class="l_k" href="functions/use.html">use</a> <span class="w">SomeDynamicallyLoadedModule</span><span class="sc">;</span></li><li></li><li>   <a class="l_k" href="functions/print.html">print</a> <span class="q">&quot;Now I can use extensions!\n&quot;</span><span class="q">&#39;</span></li></ol></pre><p><strong>ExtUtils::Embed</strong> can also automate writing the <i>xs_init</i> glue code.</p>
<pre class="verbatim"><ol><li> <span class="i">% perl</span> -<span class="w">MExtUtils::Embed</span> -e <span class="w">xsinit</span> -- -<span class="w">o</span> <span class="w">perlxsi</span>.<span class="w">c</span></li><li> % <span class="w">cc</span> -c <span class="w">perlxsi</span>.<span class="w">c</span> <span class="q">`perl -MExtUtils::Embed -e ccopts`</span></li><li> % <span class="w">cc</span> -c <span class="w">interp</span>.<span class="w">c</span>  <span class="q">`perl -MExtUtils::Embed -e ccopts`</span></li><li> % <span class="w">cc</span> -o <span class="w">interp</span> <span class="w">perlxsi</span>.<span class="w">o</span> <span class="w">interp</span>.<span class="w">o</span> <span class="q">`perl -MExtUtils::Embed -e ldopts`</span></li></ol></pre><p>Consult <a href="perlxs.html">perlxs</a>, <a href="perlguts.html">perlguts</a>, and <a href="perlapi.html">perlapi</a> for more details.</p>
<a class='view-head1' id="Embedding-Perl-under-Win32"></a><h2 class='h2' >Embedding Perl under Win32</h2>
<p>In general, all of the source code shown here should work unmodified under
Windows.</p>
<p>However, there are some caveats about the command-line examples shown.
For starters, backticks won't work under the Win32 native command shell.
The ExtUtils::Embed kit on CPAN ships with a script called
<strong>genmake</strong>, which generates a simple makefile to build a program from
a single C source file.  It can be used like this:</p>
<pre class="verbatim"><ol><li> <span class="j">C:</span>\<span class="w">ExtUtils</span>-<span class="w">Embed</span>\<span class="w">eg</span>&gt; <span class="w">perl</span> <span class="w">genmake</span> <span class="w">interp</span>.<span class="w">c</span></li><li> <span class="w">C</span><span class="co">:</span>\<span class="w">ExtUtils</span>-<span class="w">Embed</span>\<span class="w">eg</span>&gt; <span class="w">nmake</span></li><li> <span class="w">C</span><span class="co">:</span>\<span class="w">ExtUtils</span>-<span class="w">Embed</span>\<span class="w">eg</span>&gt; <span class="w">interp</span> -e <span class="q">&quot;print qq{I&#39;m embedded in Win32!\n}&quot;</span></li></ol></pre><p>You may wish to use a more robust environment such as the Microsoft
Developer Studio.  In this case, run this to generate perlxsi.c:</p>
<pre class="verbatim"><ol><li> <span class="w">perl</span> -<span class="w">MExtUtils::Embed</span> -e <span class="w">xsinit</span></li></ol></pre><p>Create a new project and Insert -&gt; Files into Project: perlxsi.c,
perl.lib, and your own source files, e.g. interp.c.  Typically you'll
find perl.lib in <strong>C:\perl\lib\CORE</strong>, if not, you should see the
<strong>CORE</strong> directory relative to <code class="inline"><span class="w">perl</span> -<span class="w">V</span><span class="co">:</span><span class="w">archlib</span></code>
.  The studio will
also need this path so it knows where to find Perl include files.
This path can be added via the Tools -&gt; Options -&gt; Directories menu.
Finally, select Build -&gt; Build interp.exe and you're ready to go.</p>
<a class='view-head1' id="MORAL"></a><h2 class='h2' >MORAL</h2>
<p>You can sometimes <i>write faster code</i> in C, but
you can always <i>write code faster</i> in Perl.  Because you can use
each from the other, combine them as you wish.</p>
<a class='view-head1' id="AUTHOR"></a><h2 class='h2' >AUTHOR</h2>
<p>Jon Orwant &lt;<i>orwant@tpj.com</i>&gt; and Doug MacEachern
&lt;<i>dougm@osf.org</i>&gt;, with small contributions from Tim Bunce, Tom
Christiansen, Guy Decoux, Hallvard Furuseth, Dov Grobgeld, and Ilya
Zakharevich.</p>
<p>Doug MacEachern has an article on embedding in Volume 1, Issue 4 of
The Perl Journal (<a href="http://tpj.com">http://tpj.com</a>).  Doug is also the developer of the
most widely-used Perl embedding: the mod_perl system
(perl.apache.org), which embeds Perl in the Apache web server.
Oracle, Binary Evolution, ActiveState, and Ben Sugars's nsapi_perl
have used this model for Oracle, Netscape and Internet Information
Server Perl plugins.</p>
<p>July 22, 1998</p>
<a class='view-head1' id="COPYRIGHT"></a><h2 class='h2' >COPYRIGHT</h2>
<p>Copyright (C) 1995, 1996, 1997, 1998 Doug MacEachern and Jon Orwant.  All
Rights Reserved.</p>
<p>Permission is granted to make and distribute verbatim copies of this
documentation provided the copyright notice and this permission notice are
preserved on all copies.</p>
<p>Permission is granted to copy and distribute modified versions of this
documentation under the conditions for verbatim copying, provided also
that they are marked clearly as modified versions, that the authors'
names and title are unchanged (though subtitles and additional
authors' names may be added), and that the entire resulting derived
work is distributed under the terms of a permission notice identical
to this one.</p>
<p>Permission is granted to copy and distribute translations of this
documentation into another language, under the above conditions for
modified versions.</p>




      <ul><li><a href="#NAME">NAME</a></li><li><a href="#DESCRIPTION">DESCRIPTION</a></li><ul><li><a href="#PREAMBLE">PREAMBLE</a></li><li><a href="#ROADMAP">ROADMAP</a></li><li><a href="#Compiling-your-C-program">Compiling your C program</a></li><li><a href="#Adding-a-Perl-interpreter-to-your-C-program">Adding a Perl interpreter to your C program</a></li><li><a href="#Calling-a-Perl-subroutine-from-your-C-program">Calling a Perl subroutine from your C program</a></li><li><a href="#Evaluating-a-Perl-statement-from-your-C-program">Evaluating a Perl statement from your C program</a></li><li><a href="#Performing-Perl-pattern-matches-and-substitutions-from-your-C-program">Performing Perl pattern matches and substitutions from your C program</a></li><li><a href="#Fiddling-with-the-Perl-stack-from-your-C-program">Fiddling with the Perl stack from your C program</a></li><li><a href="#Maintaining-a-persistent-interpreter">Maintaining a persistent interpreter</a></li><li><a href="#Maintaining-multiple-interpreter-instances">Maintaining multiple interpreter instances</a></li><li><a href="#Using-Perl-modules%2c-which-themselves-use-C-libraries%2c-from-your-C-program">Using Perl modules, which themselves use C libraries, from your C program</a></li></ul><li><a href="#Embedding-Perl-under-Win32">Embedding Perl under Win32</a></li><li><a href="#MORAL">MORAL</a></li><li><a href="#AUTHOR">AUTHOR</a></li><li><a href="#COPYRIGHT">COPYRIGHT</a></li></ul>


                  </div>
                </article>
              </div>
            </div>
          </main>
        </div>
           <footer class="footer row bg-light pt-5 pb-5">
       <div class="col-sm-10 offset-sm-1 col-xl-8 offset-xl-2">
           <div class="row">
               <div class="col-md-4">
                   <ul class="list-unstyled">
                       <li>
                           <h4>Site info</h4>
                       </li>
                       <li>Docs mantained by
                           <a href="//lists.perl.org/list/perl5-porters.html"
                               rel="noopener">Perl 5 Porters</a>
                       </li>
                       <li>Perldoc site development sponsored by
                           <a href="//opusvl.com" rel="noopener">
                           <img style="margin: 20px 20px 5px 10px" class="opus-logo" src="/public/img/opusvl_logo.svg" alt="OpusVL Logo">
                        </a>
                    <li><span class="about_perldoc"><a href="//about.html">About PerlDOC</a></span>
                    </li>
                       </li>
                   </ul>
               </div>
               <div class="col-md-8">
                   <div class="row">
                       <div class="col-md-6 col-lg-3">
                           <ul class=" list-unstyled">
                               <li>
                                   <h4>Manuals</h4>
                               </li>
                               <li>
                                   <a
                                       href="/5.6.1/index-overview.html">Overview</a>
                               </li>
                               <li>
                                   <a
                                       href="/5.6.1/index-tutorials.html">Tutorials</a>
                               </li>
                               <li>
                                   <a href="/5.6.1/index-faq.html">FAQs</a>
                               </li>
                               <li>
                                   <a
                                       href="/5.6.1/index-history.html">Changes</a>
                               </li>
                           </ul>
                       </div>
                       <div class="col-md-6 col-lg-3">
                           <ul class=" list-unstyled">
                               <li>
                                   <h4>Reference</h4>
                               </li>
                               <li>
                                   <a
                                       href="/5.6.1/index-language.html">Language</a>
                               </li>
                               <li>
                                   <a
                                       href="/5.6.1/index-functions.html">Functions</a>
                               </li>
                               <li>
                                   <a
                                       href="/5.6.1/perlop.html">Operators</a>
                               </li>
                               <li>
                                   <a
                                       href="/5.6.1/perlvar.html">Variables</a>
                               </li>
                           </ul>
                       </div>
                       <div class="col-md-6 col-lg-3">
                           <ul class=" list-unstyled">
                               <li>
                                   <h4>Modules</h4>
                               </li>
                               <li>
                                   <a
                                       href="/5.6.1/index-modules-A.html">Modules</a>
                               </li>
                               <li>
                                   <a
                                       href="/5.6.1/index-pragmas.html">Pragmas</a>
                               </li>
                               <li>
                                   <a
                                       href="/5.6.1/index-utilities.html">Utilities</a>
                               </li>
                           </ul>
                       </div>
                       <div class="col-md-6 col-lg-3">
                           <ul class=" list-unstyled">
                               <li>
                                   <h4>Misc</h4>
                               </li>
                               <li>
                                   <a
                                       href="/5.6.1/index-licence.html">License</a>
                               </li>
                               <li>
                                   <a
                                       href="/5.6.1/index-internals.html">Internals</a>
                               </li>
                               <li>
                                   <a
                                       href="/5.6.1/index-platforms.html">Platforms</a>
                               </li>
                            <li>
                                <a
                                    href="/5.6.1/index-about.html">About</a>
                            </li>
                           </ul>
                       </div>
                   </div>
               </div>
               <div class=" col-12 footer-inf text-center">
                   <small>perldoc.perl.org - Official documentation for the Perl
                       programming language</small>
               </div>
           </div>
       </div>
   </footer>

        	<div class="beta-wrapper beta-bottom-right ">
		<div class="beta beta-blue  ">
			<a class="beta-link "
				href="//github.com/OpusVL/perldoc.perl.org/issues/new" rel="noopener">
				<span class="beta-text">
					This website is a Beta release.
				</span>
				<span class="beta-text">
					For any issues please raise a ticket on GitHub
				</span>
			</a>
		</div>
	</div>

        <script src="/public/js/main.min.js"></script>
      </body>

      </html>
